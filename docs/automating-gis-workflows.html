<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Ujaval Gandhi" />


<title>Automating GIS Workflows with QGIS (Course Material)</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>




<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Automating GIS Workflows with QGIS (Course Material)</h1>
<h3 class="subtitle">A deep dive into the Processing Toolbox for building fast, automated and reproducible workflows.</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#get-the-data-package">Get the Data Package</a></li>
<li><a href="#processing-framework">Processing Framework</a><ul>
<li><a href="#processing-toolbox">Processing Toolbox</a><ul>
<li><a href="#why-should-you-use-processing-algorithms">Why should you use Processing Algorithms</a></li>
<li><a href="#review-default-settings">Review default settings</a></li>
<li><a href="#exercise-find-the-length-of-interstate-highways">Exercise: Find the length of interstate highways</a></li>
</ul></li>
<li><a href="#batch-processing">Batch Processing</a></li>
<li><a href="#graphical-modeler">Graphical Modeler</a></li>
</ul></li>
<li><a href="#data-credits">Data Credits</a></li>
<li><a href="#license">License</a></li>
</ul>
</div>


<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<p><strong>This course is also offered as an online class. Visit <a href="https://spatialthoughts.com/events/">www.spatialthoughts.com/events</a> to know details of upcoming sessions. You may also sign up for <a href="https://mailchi.mp/1d44f6c0c955/spatialthoughts">my mailing list</a> to know when new sessions are scheduled.</strong></p>
<hr />

<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This class focuses on techniques for automation of GIS workflows. The class covers the Processing Toolbox in detail.Below are the topics covered in this class</p>
<ul>
<li>Processing Providers</li>
<li>Processing Algorithms,</li>
<li>Processing Modeler</li>
<li>Batch processing</li>
</ul>
</div>
<div id="get-the-data-package" class="section level1">
<h1>Get the Data Package</h1>
<p>The code examples in this class use a variety of datasets. All the required layers, project files etc. are supplied to you in the <code>automating_gis_workflows.zip</code> file with your purchase. Unzip this file to the <code>Downloads</code> directory.</p>
</div>
<div id="processing-framework" class="section level1">
<h1>Processing Framework</h1>
<p>QGIS 2.0 introduced a new concept called Processing Framework. Previously known as Sextante, the Processing Framework provides an environment within QGIS to run native and third-party algorithms for processing data. It is now the recommended way to run any type of data processing and analysis within QGIS - including tasks such as selecting features, altering attributes, saving layers etc. - that can be accomplished by other means. But leveraging the processing framework allows you to be more productive, fast, and less error prone.</p>
<p>The Processing Framework consists of the following distinct elements that work together.</p>
<ul>
<li><strong>Processing Toolbox</strong>: Contains individual tools (i.e. algorithms) grouped by providers and functionality</li>
<li><strong>Batch Processing Interface</strong>: Allows any processing tool to be executed on multiple layers together.</li>
<li><strong>Graphical Modeler</strong>: Allows the user to define the workflow and chain multiple processing steps together using a drag-and-drop mechanism.</li>
<li><strong>History Manager</strong>: Records and stores all executions of algorithms to allow users to reproduce past analysis.</li>
<li><strong>Results Viewer</strong>: An interface to view non-spatial outputs from algorithms - such as tables and charts.</li>
</ul>
<p>We will learn about each of these through hands-on exercises in the following sections.</p>
<div id="processing-toolbox" class="section level2">
<h2>Processing Toolbox</h2>
<p>Processing Toolbox is available from the top-level menu <strong>Processing → Toolbox</strong>. There are hundreds of algorithms available out of the box. They are organized by <em>Providers</em>. The tools created by QGIS developers is available as a <strong>Native</strong> QGIS provider. Processing Framework providers an easy way to integrate tools written by other software and libraries such as GDAL, GRASS and SAGA. QGIS Plugins can also add new functionality via processing algorithms in the toolbox.</p>
<div class="figure">
<img src="images/automating_gis_workflows/toolbox_algorithms.png" />

</div>
<div id="why-should-you-use-processing-algorithms" class="section level3">
<h3>Why should you use Processing Algorithms</h3>
<ul>
<li>Well tested and rigorous implementations</li>
<li>Majority are written in C++ and are faster than alternatives</li>
<li>Long processes can run the the background while you continue to use QGIS</li>
<li>Many multi-threaded algorithms can take advantage of multi-core CPU on your machines and give you better performance</li>
<li>Robust handling of invalid geometry</li>
<li>Ability to see progress of the operation and cancel it</li>
<li>Easily run on all or just selected features</li>
</ul>
</div>
<div id="review-default-settings" class="section level3">
<h3>Review default settings</h3>
<p>You can control what providers are available in settings. The Processing Options menu also provides a way to fine-tune the configuration of the framework.</p>
<div class="figure">
<img src="images/automating_gis_workflows/processing_settings1.png" />

</div>
<p>I strongly recommend, changing the default settings and enable the option <em>Prefer output filename for layer names</em>. This option ensures that when you use batch processing, the resulting layers are unique.</p>
<div class="figure">
<img src="images/automating_gis_workflows/processing_settings2.png" />

</div>
</div>
<div id="exercise-find-the-length-of-interstate-highways" class="section level3">
<h3>Exercise: Find the length of interstate highways</h3>
<p>The aim of this exercise is to show how a multi-step spatial analysis problem can be solved using a purely processing-based workflow. This exercise also shows the richness of available algorithms in QGIS that are able to do sophisticated operations that previously needed plugins or were more complex.</p>
<p>We will work with shapefiles provided by US Census Bureau. The <code>tl_2019_us_primaryroads.zip</code> file comes TIGER/Line roads database and contains all the major roads in the US - including Interstate highways. The <code>tl_2019_us_state.zip</code> file comes from the Cartographic Boundary Files and contains the state boundaries.</p>
<ol style="list-style-type: decimal">
<li>Browse to the data directory and expand <code>tl_2019_us_primaryroads.zip</code> and <code>tl_2019_us_state.zip</code> files. Drag and drop the <code>tl_2019_us_primaryroads.shp</code> and <code>tl_2019_us_state.shp</code> layers to the canvas.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/1.png" />

</div>
<ol start="2" style="list-style-type: decimal">
<li>The layer <code>tl_2019_us_primaryroads</code> contain all major roads, including interstate highways, state highways, US highways etc. Select the layer and use the keyboard shortcut <strong>F6</strong> to open the attribute table. You will notice that the <code>RTTYP</code> column has information about road designation. As we are interested in only interstate highways, we can use the information in this column to extract relevant road segments.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/2.png" />

</div>
<ol start="3" style="list-style-type: decimal">
<li>Open the Processing Toolbox by going to <strong>Processing → Toolbox</strong></li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/3.png" />

</div>
<ol start="4" style="list-style-type: decimal">
<li>You can use tools such as <em>Select by expression</em>, export the selected features as a new layer and continue to work. But the processing toolbox providers a better and seamless workflow. Search for the algorithm <strong>Extract by attribute</strong>.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/4.png" />

</div>
<ol start="5" style="list-style-type: decimal">
<li>Select <code>tl_2019_us_primaryroads</code> as the <em>Input layer</em>. Select <code>RTTYP</code> as the <em>Selection attribute</em> and <code>I</code> as the <em>Value</em>. This will extract all feature where RTTYP value is I (Interstate). Click <em>Run</em>.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/5.png" />

</div>
<ol start="6" style="list-style-type: decimal">
<li>You will get a new layer <code>Extracted (attribute)</code> in the Layers Panel. Next, we want to calculate the length of each segment. You can use the built-in algorithm <strong>Add geometry attributes</strong></li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/6.png" />

</div>
<ol start="7" style="list-style-type: decimal">
<li>The source layer is in the Geographic CRS EPSG:4269 (NAD83) with degrees as units. But for the analysis, we want the lengths to be measured in linear units - such as miles. The algorithm provides us with a handy option to calculate the distances in <strong>Elliposidal</strong> math - which is ideal for layers in the geographic CRS. Select <code>Extracted (attribute)</code> as the <em>Input layer</em>, select <code>Ellipsoidal</code> as <em>Calculate using</em> and click <em>Run</em>.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/7.png" />

</div>
<ol start="8" style="list-style-type: decimal">
<li>A new layer with an additional field called <code>length</code> will be added to the Layers panel. The distances in this field are in meters.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/8.png" />

</div>
<ol start="9" style="list-style-type: decimal">
<li>We have the state information in the <code>tl_2019_us_state</code> layer, but not in the roads layer. To add the name of the state to the roads layer, we need to perform a spatial-join. This is done using the <strong>Join attributes by Location</strong> algorithm.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/9.png" />

</div>
<ol start="10" style="list-style-type: decimal">
<li>Select the <code>Added geom info</code> as the <em>Input layer</em> and <code>tl_2019_us_state</code> as the <em>Join layer</em>. For the <em>Fields to add</em>, we need only the <code>NAME</code> of the state.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/10.png" />

</div>
<ol start="11" style="list-style-type: decimal">
<li>Fortunately for us, each road segment is split at the state boundary. So we can select <code>Take attribute of the first located feature only</code> and click <em>Run</em> to perform a one-to-one join.</li>
</ol>
<blockquote>
<p>If our input road layers had segments that crossed state lines, we would have to do an extra step of splitting them so when we count road lengths per state - we get accurate results. You may do this by converting the states layer to lines using <em>Polygons to lines</em> algorithm, followed by the <em>Split by Lines</em> to split the road segments at the boundary.</p>
</blockquote>
<div class="figure">
<img src="images/automating_gis_workflows/11.png" />

</div>
<ol start="12" style="list-style-type: decimal">
<li>The new layer <code>Joined layer</code> now has the state name for every road segment.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/12.png" />

</div>
<ol start="13" style="list-style-type: decimal">
<li>We can now sum the road lengths and group them for each state You may recall that in earlier versions of QGIS, you needed a plugin called Group Stats to do this. But now we can do this via the built-in <strong>Statistic by Categories</strong> algorithm.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/13.png" />

</div>
<ol start="14" style="list-style-type: decimal">
<li>Select <code>Joined layer</code> as the <em>Input vector layer</em>. We want to calculate lengths, but group them by states. So select <code>length</code> as the <em>Field to calculate statistics on</em> and <code>NAME</code> as the <em>Field(s) with categories</em>. Click <em>Run</em>.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/14.png" />

</div>
<ol start="15" style="list-style-type: decimal">
<li>The output of the algorithm is a table containing various statistics on the <code>length</code> column for each state. The values in the <strong>sum</strong> column is the total length of national highways in the district.</li>
</ol>
<p><img src="images/automating_gis_workflows/15.png" /> 16. The layer contains many fields which are not relevant to us, so let’s delete some columns before saving. The <em>classic</em> way to do this is to toggle editing and use the <em>Delete Column</em> button from the Attribute Table. If you wanted to rename/reorder certain fields, that needed a plugin. But now, we have a really easy processing algorithm called <strong>Refactor Fields</strong> that can add, delete, rename, re-order, re-calculate and change the field types all at once.</p>
<div class="figure">
<img src="images/automating_gis_workflows/16.png" />

</div>
<ol start="17" style="list-style-type: decimal">
<li>In the <em>Refactor fields</em> dialog, select rows containing fields that you want to delete and click the <em>Delete selected field</em> button. Delete all except the <code>NAME</code> and <code>sum</code> fields.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/17.png" />

</div>
<ol start="18" style="list-style-type: decimal">
<li>The lengths containged in the <code>sum</code> field is in meters. We can convert it to miles here itself. Click the button next to <code>sum</code> in the <em>Source experssion</em> colummn and enter the following expression that converts meters to miles and rounds the value to the nearest integer. Click <em>OK</em>.</li>
</ol>
<pre><code>round(sum*0.000621371)</code></pre>
<div class="figure">
<img src="images/automating_gis_workflows/18.png" />

</div>
<ol start="19" style="list-style-type: decimal">
<li>We can also rename the field to a better name. Change the <em>Field name</em> of <code>NAME</code> to <code>State</code> and <code>sum</code> to <code>Length_Miles</code>. We are ready to apply the changes. So far we have created temporary output layers, but this is the final result of the analysis, so we can save it to the disk. Click the <code>...</code> button at the bottom and select <code>Save to GeoPackage</code>.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/19.png" />

</div>
<ol start="20" style="list-style-type: decimal">
<li>Enter the name of the file as <code>roads.gpkg</code>. When prompted for a layer name, enter <code>road_length_by_state</code>. Click <em>Run</em>.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/20.png" />

</div>
<ol start="21" style="list-style-type: decimal">
<li>A new layer <code>road_length_by_state</code> will be added to the <em>Layers</em> panel. The table will have the fields renamed and re-claculated as we had specified.</li>
</ol>
<div class="figure">
<img src="images/automating_gis_workflows/21.png" />

</div>
<blockquote>
<p>Note: The refactor fields algorithm has a <a href="https://github.com/qgis/QGIS/issues/32492">bug</a> for the Mac version that makes all fields as strings regardless of the user’s choice. This is a known issue and will be fixed in the future version. Till then, if you are on Mac, a workaround is to use the <em>Field Calculator</em> algorithm to take the result and add fields with correct types and conversion expressions such as to_int(), to_double() etc.</p>
</blockquote>
<p>Note that we did data processing, spatial analysis and statistical analysis - all using just processing algorithms in a fast, re-producible and intuitive workflow.</p>
</div>
</div>
<div id="batch-processing" class="section level2">
<h2>Batch Processing</h2>
<p>So far we have run the algorithm on 1 layer at a time. But each processing algorithm can also be run in a <strong>Batch</strong> mode on multiple inputs. This provides an easy way to process large amounts of data and automate repetitive tasks.</p>
<p>The batch processing interface can be invoked by right-clicking any processing algorithm and choosing <strong>Execute as Batch Process</strong>.</p>
</div>
<div id="graphical-modeler" class="section level2">
<h2>Graphical Modeler</h2>
<p>GIS Workflows typically involve many steps - with each step generating intermediate output that is used by the next step. If you change the input data or want to tweak a parameter, you will need to run through the entire process again manually. Fortunately, Processing Framework provides a graphical modeler that can help you define your workflow and run it with a single invocation. You can also run these workflows as a batch over a large number of inputs.</p>
</div>
</div>
<div id="data-credits" class="section level1">
<h1>Data Credits</h1>
<ul>
<li>[TIGER/Line Shapefiles 2019[(<a href="https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html" class="uri">https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html</a>)], US Census Bureau.</li>
<li><a href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html">Cartographic Boundary Files</a> for US States, US Census Bureau.</li>
</ul>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>This course material is licensed under a <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>. You are free to use the material for any non-commercial purpose. Kindly give appropriate credit to the original author</p>
<p>If you would like to use this material for commercial use or for teaching a course, kindly <a href="https://spatialthoughts.com/contact/">contact me</a> for terms.</p>
<p>© 2020 Ujaval Gandhi <a href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
