<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Ujaval Gandhi" />


<title>Customizing QGIS with Python (Course Material)</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Customizing QGIS with Python (Course Material)</h1>
<h3 class="subtitle">Learn the QGIS Python API from the ground up</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#get-the-data-package">Get the Data Package</a></li>
<li><a href="#where-can-you-use-python-in-qgis">Where can you use Python in QGIS?</a></li>
<li><a href="#qt-pyqt-and-pyqgis">Qt, PyQt and PyQGIS</a><ul>
<li><a href="#qt">Qt</a></li>
<li><a href="#pyqt">PyQt</a></li>
<li><a href="#pyqgis">PyQGIS</a></li>
</ul></li>
<li><a href="#hello-world">Hello World!</a></li>
<li><a href="#getting-familiar-with-python">Getting familiar with Python</a><ul>
<li><a href="#calculate-distance-using-haversine-formula">Calculate distance using Haversine formula</a></li>
<li><a href="#calculate-distance-using-pyqgis">Calculate distance using PyQGIS</a></li>
</ul></li>
<li><a href="#understanding-classes">Understanding Classes</a><ul>
<li><a href="#classes-vs-objects">Classes vs Objects</a></li>
<li><a href="#inspecting-objects">Inspecting Objects</a></li>
<li><a href="#methods-or-functions">Methods (or functions)</a></li>
<li><a href="#instance-attributes">Instance Attributes</a></li>
<li><a href="#class-attributes">Class Attributes</a></li>
<li><a href="#inheritance">Inheritance</a></li>
<li><a href="#putting-it-all-together">Putting it all together</a></li>
</ul></li>
<li><a href="#visual-tour-of-the-pyqgis-api">Visual Tour of the PyQGIS API</a><ul>
<li><a href="#qgis-main-window">QGIS Main Window</a></li>
<li><a href="#menus">Menus</a></li>
<li><a href="#toolbars">Toolbars</a></li>
<li><a href="#projects">Projects</a></li>
<li><a href="#map-canvas">Map Canvas</a></li>
<li><a href="#layers-panel-table-of-contents-toc">Layers Panel / Table of Contents (TOC)</a></li>
<li><a href="#adding-data-sources">Adding Data Sources</a></li>
<li><a href="#symbology-and-labeling">Symbology and Labeling</a></li>
<li><a href="#processing">Processing</a></li>
<li><a href="#print-layouts">Print Layouts</a></li>
</ul></li>
<li><a href="#running-python-code-at-qgis-launch">Running Python Code at QGIS Launch</a><ul>
<li><a href="#exercise">Exercise</a></li>
</ul></li>
<li><a href="#creating-custom-python-actions">Creating Custom Python Actions</a></li>
<li><a href="#writing-python-console-scripts">Writing Python Console Scripts</a></li>
<li><a href="#writing-standalone-python-scripts">Writing Standalone Python Scripts</a></li>
<li><a href="#processing-scripts">Processing Scripts</a><ul>
<li><a href="#writing-a-python-class">Writing a Python Class</a></li>
<li><a href="#writing-a-processing-script">Writing a Processing Script</a></li>
<li><a href="#simplifying-processing-scripts">Simplifying Processing Scripts</a></li>
</ul></li>
<li><a href="#writing-plugins">Writing Plugins</a><ul>
<li><a href="#a-minimal-plugin">A Minimal Plugin</a></li>
<li><a href="#processing-plugin">Processing Plugin</a></li>
<li><a href="#gui-plugin">GUI Plugin</a></li>
</ul></li>
<li><a href="#writing-python-expression-functions">Writing Python Expression Functions</a><ul>
<li><a href="#custom-function-to-find-utm-zone-of-a-feature">Custom function to find UTM Zone of a feature</a></li>
<li><a href="#exercise-2">Exercise</a></li>
</ul></li>
<li><a href="#resources-for-further-learning">Resources for Further Learning</a></li>
<li><a href="#data-credits">Data Credits</a></li>
<li><a href="#license">License</a></li>
</ul>
</div>


<hr />
<p><strong>This course is also offered as an in-person class. To attend one of my workshops, visit the <a href="https://spatialthoughts.com/events/">Upcoming Classes</a> page. Please sign up for <a href="https://mailchi.mp/1d44f6c0c955/spatialthoughts">my mailing list</a> to know when new sessions are scheduled.</strong></p>
<hr />

<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This class introduces the concepts of Python programming within the QGIS environment. We will cover the full breadth of topics that involve everything from using the Python Console to building a fully functional plugin. We will also explore GUI programming techniques for customizing the QGIS interface using Qt widgets.</p>
</div>
<div id="get-the-data-package" class="section level1">
<h1>Get the Data Package</h1>
<p>The code examples in this class use a variety of datasets. All the required layers, project files, icons etc. are available in the <a href="https://drive.google.com/uc?export=download&amp;id=1VvQwNZK6yc3Bnw0GWc6gftIHmNyNPoDK">pyqgis_in_a_day.zip</a> [~70MB]. Download and unzip this file to the <code>Downloads</code> directory. All scripts assume the data is available in the <code>&lt;home folder&gt;/Downloads/pyqgis_in_a_day/</code> directory.</p>
</div>
<div id="where-can-you-use-python-in-qgis" class="section level1">
<h1>Where can you use Python in QGIS?</h1>
<ul>
<li>Issue commands from Python Console</li>
<li>Automatically run python code when QGIS starts</li>
<li>Write custom expressions</li>
<li>Write custom actions</li>
<li>Create new processing algorithms</li>
<li>Create plugins</li>
<li>Create custom standalone applications</li>
</ul>
</div>
<div id="qt-pyqt-and-pyqgis" class="section level1">
<h1>Qt, PyQt and PyQGIS</h1>
<div id="qt" class="section level2">
<h2>Qt</h2>
<p><a href="https://www.qt.io/">Qt</a> is a free and open-source widget toolkit for creating graphical user interfaces as well as cross-platform applications.</p>
<p>QGIS is built using the Qt platform. Both QT and QGIS itself have well-documented APIs that should be used when writing Python code to be run within QGIS.</p>
</div>
<div id="pyqt" class="section level2">
<h2>PyQt</h2>
<p><a href="https://wiki.python.org/moin/PyQt">PyQt</a> is the Python interface to Qt. PyQt provides classes and functions to interact with Qt widgets.</p>
</div>
<div id="pyqgis" class="section level2">
<h2>PyQGIS</h2>
<p>QGIS provides a Python API (Application Programming Interface), commonly known as PyQGIS. <a href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/">PyQGIS</a> is created using SIP and integrates with PyQt.</p>
<blockquote>
<p><strong><em>Fun Fact:</em></strong> Most QGIS class names start with the prefix <em>Qgs</em>. <strong>Q</strong> is for QT and <strong>gs</strong> stands for Gary Sherman - the founder of the QGIS project.</p>
</blockquote>
<p>C++ API documentation is available at <a href="https://qgis.org/api/" class="uri">https://qgis.org/api/</a></p>
<p>Python API documentation is available at <a href="https://qgis.org/pyqgis/3.0" class="uri">https://qgis.org/pyqgis/3.0</a></p>
<p>Both C++ and Python APIs are identical for most part, but certain functions are not available in the Python API. <a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></p>
</div>
</div>
<div id="hello-world" class="section level1">
<h1>Hello World!</h1>
<p>QGIS Comes with a built-in <strong>Python Console</strong> and a code editor where you can write and run Python code.</p>
<p>Go to <strong>Plugins → Python Console</strong> to open the console.</p>
<p><img src="images/pyqgis/console.png" style="display: block; margin: auto;" /></p>
<p>At the <code>&gt;&gt;&gt;</code> prompt, type in the following command and press Enter.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">print</span>(<span class="st">&#39;Hello World!&#39;</span>)</code></pre></div>
<p>Here you are running Python’s <em>print()</em> function with the text ‘Hello World’. The output of the statement will be printed below.</p>
<p><img src="images/pyqgis/helloworld.png" style="display: block; margin: auto;" /></p>
<p>While console is useful for typing 1-2 lines of code or printing information contained in a variable, you should use the built-in editor for typing longer scripts or code snippets. Click the <em>Show Editor</em> button to open the editor panel. Enter the code and click the <em>Run Script</em> button to execute it. The results will appear in the console as before. If you are working on a longer script, you can also click the <em>Save</em> button in the editor to save the script for future use.</p>
<p><img src="images/pyqgis/editor.png" style="display: block; margin: auto;" /></p>
</div>
<div id="getting-familiar-with-python" class="section level1">
<h1>Getting familiar with Python</h1>
<p>If you are new to Python, you can get started with basics of the language at LearnPython.org’s <a href="https://www.learnpython.org/">interactive Python tutorial</a>. For a slightly more advanced introduction, I recommend <a href="https://allendowney.github.io/ElementsOfDataScience/">Elements of Data Science</a> by Allen Downey which introduces Python with a Data Science focus. Both of these are free resources that are suited for beginners with no programming experience.</p>
<p>For this course, we will learn basics of Python by by building a script to calculate distance between 2 points.</p>
<div id="calculate-distance-using-haversine-formula" class="section level2">
<h2>Calculate distance using Haversine formula</h2>
<p>Given 2 points with their Latitude and Longitude coordinates, the <a href="https://en.wikipedia.org/wiki/Haversine_formula">Haversine Formula</a> calculates the distance in meters, assuming that Earth is a sphere.</p>
<p>The formula is simple enough to be implemented in a spreadsheet too. If you are curious, see <a href="https://spatialthoughts.com/2013/07/06/calculate-distance-spreadsheet/">my post</a> about using this formula for calculating distances in a spreadsheet.</p>
<p>First, let’s define out origin and destination. You can store a pair of values in a variable using a <em>tuple</em> as below.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">origin <span class="op">=</span> <span class="fl">12.98</span>, <span class="fl">77.58</span> <span class="co"># Bangalore</span>
destination <span class="op">=</span> <span class="fl">12.30</span>, <span class="fl">76.64</span> <span class="co"># Mysore</span>
<span class="bu">print</span>(origin)
<span class="bu">print</span>(destination)</code></pre></div>
<p>You can check the data type using the <code>type</code> function. You can access the values from tuples using their index, starting from 0.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">print</span>(<span class="bu">type</span>(origin))
<span class="bu">print</span>(origin[<span class="dv">0</span>])
<span class="bu">print</span>(origin[<span class="dv">1</span>])</code></pre></div>
<p>You can print multiple values using the <code>print</code> functions as well.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">print</span>(<span class="st">&#39;Origin coordinates are: &#39;</span>, origin[<span class="dv">0</span>], <span class="st">&#39;,&#39;</span>, origin[<span class="dv">1</span>])</code></pre></div>
<p>There is a handy <code>format</code> function that allows creating strings easily.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">output <span class="op">=</span> <span class="st">&#39;Origin coordinates are: </span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(origin[<span class="dv">0</span>], origin[<span class="dv">1</span>])
<span class="bu">print</span>(output)</code></pre></div>
<p>Python supports doing basic math operations such as addition, multiplication, division etc. by default. Advance mathematical operations are also supported and comes with the the Python Standard Library. We can use the built-in <code>math</code> module to do trigonometric calculations in the haversine formula.</p>
<p>Here’s how we can implement the haversine formula in Python. <a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> math

lat1, lon1 <span class="op">=</span> origin
lat2, lon2 <span class="op">=</span> destination
radius <span class="op">=</span> <span class="dv">6371</span> <span class="co"># km</span>
dlat <span class="op">=</span> math.radians(lat2<span class="op">-</span>lat1)
dlon <span class="op">=</span> math.radians(lon2<span class="op">-</span>lon1)
a <span class="op">=</span> math.sin(dlat<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> math.sin(dlat<span class="op">/</span><span class="dv">2</span>) <span class="op">+</span> math.cos(math.radians(lat1)) <span class="op">\</span>
    <span class="op">*</span> math.cos(math.radians(lat2)) <span class="op">*</span> math.sin(dlon<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> math.sin(dlon<span class="op">/</span><span class="dv">2</span>)
c <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> math.atan2(math.sqrt(a), math.sqrt(<span class="dv">1</span><span class="op">-</span>a))
distance <span class="op">=</span> radius <span class="op">*</span> c
<span class="bu">print</span>(distance)</code></pre></div>
<p>This code works, but if we had to compute distance for another pair of coordinates, we will have to write the same block of code again. For computations that need to be called multiple times, it is better to capture then in a function. It takes some inputs, processes the inputs and returns the results. It is defined using the <code>def</code> keyword. We define a new function called <code>haversine_distance</code> which takes 2 arguments, <em>origin</em> and <em>destination</em> and returns the distance.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> haversine_distance(origin, destination):
  ...
  ...
  <span class="cf">return</span> distance</code></pre></div>
<p>We can compelte the function using the code we used previously</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> haversine_distance(origin, destination):
  lat1, lon1 <span class="op">=</span> origin
  lat2, lon2 <span class="op">=</span> destination
  radius <span class="op">=</span> <span class="dv">6371</span> <span class="co"># km</span>
  dlat <span class="op">=</span> math.radians(lat2<span class="op">-</span>lat1)
  dlon <span class="op">=</span> math.radians(lon2<span class="op">-</span>lon1)
  a <span class="op">=</span> math.sin(dlat<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> math.sin(dlat<span class="op">/</span><span class="dv">2</span>) <span class="op">+</span> math.cos(math.radians(lat1)) <span class="op">\</span>
    <span class="op">*</span> math.cos(math.radians(lat2)) <span class="op">*</span> math.sin(dlon<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> math.sin(dlon<span class="op">/</span><span class="dv">2</span>)
  c <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> math.atan2(math.sqrt(a), math.sqrt(<span class="dv">1</span><span class="op">-</span>a))
  distance <span class="op">=</span> radius <span class="op">*</span> c
  <span class="cf">return</span> distance</code></pre></div>
<p>Now we can call this function with any pair of origin and destination coordinates and get the distance</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">origin <span class="op">=</span>  <span class="fl">12.98</span>, <span class="fl">77.58</span> <span class="co"># Bangalore</span>
destination <span class="op">=</span> <span class="fl">13.08</span>, <span class="fl">80.27</span> <span class="co"># Chennai</span>
distance <span class="op">=</span> haversine_distance(origin, destination)
<span class="bu">print</span>(distance)</code></pre></div>
</div>
<div id="calculate-distance-using-pyqgis" class="section level2">
<h2>Calculate distance using PyQGIS</h2>
<p>The orevious example used the Haversine formula for calculating distances, which assumes the Earth is a sphere. But since the actual shape of Earth is more complex, and is closer to an ellipsoid - a spherical calculation is not accurate - especially where the distance is large. QGIS has built-in methods for doing accurate ellipsoid-based distance calculations using <a href="https://en.wikipedia.org/wiki/Vincenty%27s_formulae">Vincenty’s formulae</a>. We can use the PyQGIS API to call these methods and calculate distances. <a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> ellipsoid_distance(origin, destination):
  lat1, lon1 <span class="op">=</span> origin
  lat2, lon2 <span class="op">=</span> destination
  <span class="co"># Remember the order is X,Y</span>
  point1 <span class="op">=</span> QgsPointXY(lon1, lat1)
  point2 <span class="op">=</span> QgsPointXY(lon2, lat2)

  d <span class="op">=</span> QgsDistanceArea()
  d.setEllipsoid(<span class="st">&#39;WGS84&#39;</span>)

  <span class="co">#Measure the distance</span>
  distance <span class="op">=</span> d.measureLine([point1, point2])
  <span class="cf">return</span> distance<span class="op">/</span><span class="dv">1000</span></code></pre></div>
<p>Putting it all together, we can compare the distances using both Haversine and Ellipsoid methods</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> math

<span class="kw">def</span> ellipsoid_distance(origin, destination):
  lat1, lon1 <span class="op">=</span> origin
  lat2, lon2 <span class="op">=</span> destination
  <span class="co"># Remember the order is X,Y</span>
  point1 <span class="op">=</span> QgsPoint(lon1, lat1)
  point2 <span class="op">=</span> QgsPoint(lon2, lat2)

  d <span class="op">=</span> QgsDistanceArea()
  d.setEllipsoid(<span class="st">&#39;WGS84&#39;</span>)

  <span class="co">#Measure the distance</span>
  distance <span class="op">=</span> d.measureLine(point1, point2)
  <span class="cf">return</span> distance<span class="op">/</span><span class="dv">1000</span>
  
<span class="kw">def</span> haversine_distance(origin, destination):
  lat1, lon1 <span class="op">=</span> origin
  lat2, lon2 <span class="op">=</span> destination
  radius <span class="op">=</span> <span class="dv">6371</span> <span class="co"># km</span>
  dlat <span class="op">=</span> math.radians(lat2<span class="op">-</span>lat1)
  dlon <span class="op">=</span> math.radians(lon2<span class="op">-</span>lon1)
  a <span class="op">=</span> math.sin(dlat<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> math.sin(dlat<span class="op">/</span><span class="dv">2</span>) <span class="op">+</span> math.cos(math.radians(lat1)) <span class="op">\</span>
    <span class="op">*</span> math.cos(math.radians(lat2)) <span class="op">*</span> math.sin(dlon<span class="op">/</span><span class="dv">2</span>) <span class="op">*</span> math.sin(dlon<span class="op">/</span><span class="dv">2</span>)
  c <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> math.atan2(math.sqrt(a), math.sqrt(<span class="dv">1</span><span class="op">-</span>a))
  distance <span class="op">=</span> radius <span class="op">*</span> c
  <span class="cf">return</span> distance
  
origin <span class="op">=</span> <span class="fl">12.98</span>, <span class="fl">77.58</span> <span class="co"># Bangalore</span>
destination <span class="op">=</span> <span class="fl">12.30</span>, <span class="fl">76.64</span> <span class="co"># Mysore</span>

d1 <span class="op">=</span> haversine_distance(origin, destination)
d2 <span class="op">=</span> ellipsoid_distance(origin, destination)

<span class="bu">print</span>(<span class="st">&#39;{Haversine distance: </span><span class="sc">{}</span><span class="st"> km&#39;</span>.<span class="bu">format</span>(d1))
<span class="bu">print</span>(<span class="st">&#39;{Ellipsoid distance: </span><span class="sc">{}</span><span class="st"> km&#39;</span>.<span class="bu">format</span>(d2))</code></pre></div>
<p><img src="images/pyqgis/distance.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="understanding-classes" class="section level1">
<h1>Understanding Classes</h1>
<p>Before we dive it to PyQGIS, it is important to understand certain concepts related to C++ and Python Classes. Qt as well as QGIS is written in C++ language. Functionality of each Qt/QGIS Widget is implemented as a class - having certain properties and functions. When we use PyQt or PyQGIS classes, it is executing the code in the C++ classes via the python bindings.</p>
<div id="classes-vs-objects" class="section level2">
<h2>Classes vs Objects</h2>
<p>A class can be thought of as a template. You cannot use it directly. To use it in a program, you must create an ‘instance’ of it - which uses the template along with the supplied parameters to create an instance of the class. This is known as an object.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">mb <span class="op">=</span> QMessageBox()</code></pre></div>
<p>The <code>QMessageBox</code> is a PyQt class for creating a dialog with buttons. To use the class, you create object by <em>instantiating</em> the class. Here <code>mb</code> is an object, which is an instance of the <code>QMessageBox</code> class, created using the default parameters.</p>
</div>
<div id="inspecting-objects" class="section level2">
<h2>Inspecting Objects</h2>
<p><code>type()</code> tells you what is the class of the object</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">type</span>(mb)</code></pre></div>
<p><code>dir</code> returns list of the attributes and methods of any object</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">dir</span>(mb)</code></pre></div>
</div>
<div id="methods-or-functions" class="section level2">
<h2>Methods (or functions)</h2>
<p>Classes have methods that provide functionality. You can run the class methods on instance objects. For the <code>QMessageBox</code> class, <code>setText()</code> method will add a text to the dialog.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">mb <span class="op">=</span> QMessageBox()
mb.setText(<span class="st">&#39;Click OK to confirm&#39;</span>)</code></pre></div>
</div>
<div id="instance-attributes" class="section level2">
<h2>Instance Attributes</h2>
<p>Classes have 2 types of attributes - class attributes and instance attributes. Qt provides access functions for instance attributes. For the <code>QMessageBox</code> class, there is a <code>text()</code> method to get the text attribute of the mb instance.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">mb <span class="op">=</span> QMessageBox()
mb.setText(<span class="st">&#39;Click OK to confirm&#39;</span>)
<span class="bu">print</span>(mb.text())</code></pre></div>
</div>
<div id="class-attributes" class="section level2">
<h2>Class Attributes</h2>
<p>Classes also have class attributes which are shared across all instances. The <code>QMessageBox</code> class has <code>Ok</code> and <code>Cancel</code> attributes, which can be referred using <code>QMessageBox.Ok</code> and <code>QMessageBox.Cancel</code>.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">mb <span class="op">=</span> QMessageBox()
mb.setText(<span class="st">&#39;Click OK to confirm&#39;</span>)
mb.setStandardButtons(QMessageBox.Ok <span class="op">|</span> QMessageBox.Cancel)</code></pre></div>
</div>
<div id="inheritance" class="section level2">
<h2>Inheritance</h2>
<p><code>QObject</code> is the most basic class in Qt. All Qt widgets and QGIS classes inherit from QObject. The most basic widget is the QWidget. <code>QWidget</code> contains most properties that are used to describe a window, or a widget, like position and size, mouse cursor, tooltips, etc. The <code>QDialog</code> class is the base class of dialog windows. <code>QMessageBox</code> is a specialized QDialog.</p>
<p><img src="images/pyqgis/inheritance.png" width="300px" style="display: block; margin: auto;" /></p>
</div>
<div id="putting-it-all-together" class="section level2">
<h2>Putting it all together</h2>
<p>Try out this simple example which constructs a confirmation dialog using PyQt. You can type the code in the <strong>Editor</strong> and click <strong>Run Script</strong>.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">mb <span class="op">=</span> QMessageBox()
mb.setText(<span class="st">&#39;Click OK to confirm&#39;</span>)
mb.setStandardButtons(QMessageBox.Ok <span class="op">|</span> QMessageBox.Cancel)
return_value <span class="op">=</span> mb.<span class="bu">exec</span>()
<span class="cf">if</span> return_value <span class="op">==</span> QMessageBox.Ok:
    <span class="bu">print</span>(<span class="st">&#39;You pressed OK&#39;</span>)
<span class="cf">elif</span> return_value <span class="op">==</span> QMessageBox.Cancel:
    <span class="bu">print</span>(<span class="st">&#39;You pressed Cancel&#39;</span>)</code></pre></div>
<p><img src="images/pyqgis/messagebox.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="visual-tour-of-the-pyqgis-api" class="section level1">
<h1>Visual Tour of the PyQGIS API</h1>
<p>The <code>QgisInterface</code> class provides methods for interaction with the QGIS environment. When QGIS is running, a variable called <code>iface</code> is set up to provide an object of the class <code>QgisInterface</code> to interact with the running QGIS environment. This interface allows access to the map canvas, menus, toolbars and other parts of the QGIS application. Python Console and Plugins can use <code>iface</code> to access various parts of the QGIS interface.</p>
<div id="qgis-main-window" class="section level2">
<h2>QGIS Main Window</h2>
<p><strong><code>iface.mainWindow()</code></strong></p>
<p><img src="images/pyqgis/mainwindow1.png" style="display: block; margin: auto;" /></p>
<div id="change-title" class="section level3">
<h3>Change Title</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">title <span class="op">=</span> iface.mainWindow().windowTitle()
new_title <span class="op">=</span> title.replace(<span class="st">&#39;QGIS&#39;</span>, <span class="st">&#39;My QGIS&#39;</span>)
iface.mainWindow().setWindowTitle(new_title)</code></pre></div>
</div>
<div id="change-icon" class="section level3">
<h3>Change Icon</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os

icon <span class="op">=</span> <span class="st">&#39;qgis-black.png&#39;</span>
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)
icon_path <span class="op">=</span> os.path.join(data_dir, icon)
icon <span class="op">=</span> QIcon(icon_path)
iface.mainWindow().setWindowIcon(icon)</code></pre></div>
<p><img src="images/pyqgis/mainwindow2.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="menus" class="section level2">
<h2>Menus</h2>
<p><strong><code>iface.projectMenu()</code></strong></p>
<p><strong><code>iface.vectorMenu()</code></strong></p>
<p><strong><code>iface.viewMenu()</code></strong></p>
<p><strong><code>iface.helpMenu()</code></strong></p>
<p><strong>…</strong></p>
<p><img src="images/pyqgis/menu1.png" style="display: block; margin: auto;" /></p>
<div id="remove-raster-and-vector-menus" class="section level3">
<h3>Remove Raster and Vector Menus</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">vector_menu <span class="op">=</span> iface.vectorMenu()
raster_menu <span class="op">=</span> iface.rasterMenu()
menubar <span class="op">=</span> vector_menu.parentWidget()
menubar.removeAction(vector_menu.menuAction())
menubar.removeAction(raster_menu.menuAction())</code></pre></div>
<p><img src="images/pyqgis/menu2.1.png" style="display: block; margin: auto;" /></p>
<p><img src="images/pyqgis/menu2.2.png" style="display: block; margin: auto;" /></p>
</div>
<div id="add-a-new-menu-item" class="section level3">
<h3>Add A New Menu Item</h3>
<div id="signals-and-slots" class="section level4">
<h4>Signals and Slots</h4>
<p>GUI programming requires responding to user’s actions. All objects in Qt have a mechanism where they can emit a signal when there is a change in status. i.e. when a user <em>clicks</em> a button, or a window is <em>closed</em>. As a programmer, you can connect the signal to a slot (i.e. a python function) which will be called when the signal is emitted. The general syntax for connecting the signal to a slot is as follows</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">object</span>.signal.<span class="ex">connect</span>(function)</code></pre></div>
<p>A new button or menu item is created using <code>QAction()</code>. Here we create an action and then connect the <em>click</em> signal to a method that opens a website. <a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> webbrowser

<span class="kw">def</span> open_website():
    webbrowser.<span class="bu">open</span>(<span class="st">&#39;https://gis.stackexchange.com&#39;</span>)

website_action <span class="op">=</span> QAction(<span class="st">&#39;Go to gis.stackexchange&#39;</span>)
website_action.triggered.<span class="ex">connect</span>(open_website)
iface.helpMenu().addSeparator()
iface.helpMenu().addAction(website_action)</code></pre></div>
<p><img src="images/pyqgis/menu3.png" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="toolbars" class="section level2">
<h2>Toolbars</h2>
<p><strong><code>iface.pluginToolBar()</code></strong></p>
<p><strong><code>iface.attributesToolBar()</code></strong></p>
<p><strong><code>iface.mapNavToolToolBar()</code></strong></p>
<p><strong>…</strong></p>
<p><img src="images/pyqgis/toolbar.png" style="display: block; margin: auto;" /></p>
<div id="change-visibility-of-a-toolbar" class="section level3">
<h3>Change Visibility of a Toolbar</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">iface.pluginToolBar().setVisible(<span class="va">True</span>)</code></pre></div>
</div>
<div id="add-a-button-to-a-toolbar" class="section level3">
<h3>Add a button to a toolbar</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
<span class="im">from</span> datetime <span class="im">import</span> datetime

icon <span class="op">=</span> <span class="st">&#39;question.svg&#39;</span>
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)
icon_path <span class="op">=</span> os.path.join(data_dir, icon)

<span class="kw">def</span> show_time():
    now <span class="op">=</span> datetime.now()
    current_time <span class="op">=</span> now.strftime(<span class="st">&quot;%H:%M:%S&quot;</span>)
    iface.messageBar().pushMessage(<span class="st">&#39;Time is </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(current_time))
    
action <span class="op">=</span> QAction(<span class="st">&#39;Show Time&#39;</span>)
action.triggered.<span class="ex">connect</span>(show_time)
action.setIcon(QIcon(icon_path))
iface.addToolBarIcon(action)</code></pre></div>
<p><img src="images/pyqgis/toolbar2.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="projects" class="section level2">
<h2>Projects</h2>
<p><strong><code>QgsProject.instance()</code></strong></p>
<div id="load-a-project" class="section level3">
<h3>Load a project</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)

project <span class="op">=</span> QgsProject.instance()
project_name <span class="op">=</span> <span class="st">&#39;sf.qgz&#39;</span>
project_path <span class="op">=</span> os.path.join(data_dir, project_name)
project.read(project_path)</code></pre></div>
<p><img src="images/pyqgis/project.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="map-canvas" class="section level2">
<h2>Map Canvas</h2>
<p><strong><code>iface.mapCanvas()</code></strong></p>
<p><img src="images/pyqgis/mapcanvas.png" style="display: block; margin: auto;" /></p>
<div id="set-canvas-extent-to-a-layer-extent" class="section level3">
<h3>Set Canvas Extent to a Layer Extent</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">layer <span class="op">=</span> iface.activeLayer()
mc <span class="op">=</span> iface.mapCanvas()
mc.setExtent(layer.extent())
mc.refresh()</code></pre></div>
</div>
<div id="save-map-as-an-image" class="section level3">
<h3>Save Map as an Image</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)
image_name <span class="op">=</span> <span class="st">&#39;sf.png&#39;</span>
image_path <span class="op">=</span> os.path.join(data_dir, image_name)
mc <span class="op">=</span> iface.mapCanvas()
mc.saveAsImage(image_path)</code></pre></div>
<p><img src="images/pyqgis/sf.png" style="display: block; margin: auto;" /></p>
</div>
<div id="save-map-rendering-as-an-image" class="section level3">
<h3>Save Map Rendering as an Image</h3>
<p><code>saveAsImage()</code> method is quick and easy, but you do not have much control over the resulting image. You can’t control the resolution, size or how each layer will be rendered. There is another way to achieve this. You can look at the code for exporting map as an image in QGIS and you will discover 2 classes <code>QgsMapRendererParallelJob</code> and <code>QgsMapRendererSequentialJob</code> that lets you achieve a better result. The code snippet below exports a hi-resolution image of the project. <a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)
image_name <span class="op">=</span> <span class="st">&#39;sf_hires.png&#39;</span>
image_path <span class="op">=</span> os.path.join(data_dir, image_name)

settings <span class="op">=</span> iface.mapCanvas().mapSettings()
settings.setOutputSize(QSize(<span class="dv">1000</span>,<span class="dv">1000</span>))

settings.setFlag(QgsMapSettings.DrawLabeling, <span class="va">False</span>)
settings.setFlag(QgsMapSettings.Antialiasing, <span class="va">True</span>)

job <span class="op">=</span> QgsMapRendererSequentialJob(settings)
job.start()
job.waitForFinished()
image <span class="op">=</span> job.renderedImage()
image.save(image_path)</code></pre></div>
<p><img src="images/pyqgis/sf_hires.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="layers-panel-table-of-contents-toc" class="section level2">
<h2>Layers Panel / Table of Contents (TOC)</h2>
<p><strong><code>iface.activeLayer()</code></strong></p>
<p><strong><code>iface.layerTreeView()</code></strong></p>
<p><strong><code>iface.mapCanvas().layers()</code></strong></p>
<p><strong><code>QgsProject.instance().mapLayers()</code></strong></p>
<p><strong><code>QgsProject.instance().layerTreeRoot()</code></strong></p>
<p><img src="images/pyqgis/layerspanel.png" style="display: block; margin: auto;" /></p>
<div id="change-name-of-a-layer" class="section level3">
<h3>Change name of a Layer</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">layer <span class="op">=</span> iface.activeLayer()
name <span class="op">=</span> layer.name()
layer.setName(<span class="st">&#39;sf_&#39;</span> <span class="op">+</span> name)</code></pre></div>
</div>
<div id="get-all-layers" class="section level3">
<h3>Get all Layers</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="cf">for</span> layer <span class="kw">in</span> QgsProject.instance().mapLayers().values():
    <span class="bu">print</span>(layer.name())</code></pre></div>
</div>
<div id="get-only-checked-visible-layers" class="section level3">
<h3>Get only checked (visible) Layers</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="cf">for</span> layer <span class="kw">in</span> iface.mapCanvas().layers():
    <span class="bu">print</span>(layer.name())</code></pre></div>
</div>
<div id="get-only-selected-layers" class="section level3">
<h3>Get only selected Layers</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="cf">for</span> layer <span class="kw">in</span> iface.layerTreeView().selectedLayers():
  <span class="bu">print</span>(layer.name())</code></pre></div>
</div>
<div id="get-layers-with-hierarchy" class="section level3">
<h3>Get Layers with Hierarchy</h3>
<p>This code snippet is taken from the <a href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/cheat_sheet.html">Cheat Sheet for PyQGIS</a> , but contains an important modification. If you notice carefully, the function <code>getGroupLayers</code> is called recursively from within <code>getGroupLayers</code>. This allows one to even get layers that have sub-groups within layer groups.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> getGroupLayers(group):
    <span class="bu">print</span>(<span class="st">&#39;- group:&#39;</span> <span class="op">+</span> group.name())
    <span class="cf">for</span> child <span class="kw">in</span> group.children():
        <span class="cf">if</span> <span class="bu">isinstance</span>(child, QgsLayerTreeGroup):
            getGroupLayers(child)
        <span class="cf">else</span>:
            <span class="bu">print</span>(<span class="st">&#39;  - layer:&#39;</span> <span class="op">+</span> child.name())


root <span class="op">=</span> QgsProject.instance().layerTreeRoot()
<span class="cf">for</span> child <span class="kw">in</span> root.children():
    <span class="cf">if</span> <span class="bu">isinstance</span>(child, QgsLayerTreeGroup):
        getGroupLayers(child)
    <span class="cf">elif</span> <span class="bu">isinstance</span>(child, QgsLayerTreeLayer):
        <span class="bu">print</span> (<span class="st">&quot;- layer: &quot;</span> <span class="op">+</span> child.name())</code></pre></div>
<p><img src="images/pyqgis/layergroup.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="adding-data-sources" class="section level2">
<h2>Adding Data Sources</h2>
<p><strong><code>iface.addRasterLayer()</code></strong></p>
<p><strong><code>iface.addVectorLayer()</code></strong></p>
<p><strong>..</strong></p>
<p><strong><code>QgsProject.instance().addMapLayer()</code></strong></p>
<p><strong><code>QgsProject.instance().addMapLayers()</code></strong></p>
<p><img src="images/pyqgis/addlayer.png" style="display: block; margin: auto;" /></p>
<p>Data sources are identified by an URI (Uniform Resource Identifier) - For files on computer the URI is the file path - For databases, the URI is constructed using QgsDataSourceUri() class and encodes,the database path, table, username, password etc. - For web layers, such as WMF/WFS etc, the URI is the web URL</p>
<div id="adding-vector-layers" class="section level3">
<h3>Adding Vector Layers</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)

filename <span class="op">=</span> <span class="st">&#39;seismic_zones.shp&#39;</span>
uri <span class="op">=</span> os.path.join(data_dir, filename)
iface.addVectorLayer(uri, <span class="st">&#39;seismic_zones&#39;</span>, <span class="st">&#39;ogr&#39;</span>)

filename <span class="op">=</span> <span class="st">&#39;sf.gpkg|layername=zoning&#39;</span>
uri <span class="op">=</span> os.path.join(data_dir, filename)
iface.addVectorLayer(uri, <span class="st">&#39;zoning&#39;</span>, <span class="st">&#39;ogr&#39;</span>)

filename <span class="op">=</span> <span class="st">&#39;trees.csv&#39;</span>
csvpath <span class="op">=</span> <span class="st">&#39;file:///&#39;</span> <span class="op">+</span> data_dir <span class="op">+</span> filename
uri <span class="op">=</span> <span class="st">&#39;</span><span class="sc">{}</span><span class="st">?type=csv&amp;xField=</span><span class="sc">{}</span><span class="st">&amp;yField=</span><span class="sc">{}</span><span class="st">&amp;crs=</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(
  csvpath, <span class="st">&#39;Longitude&#39;</span>, <span class="st">&#39;Latitude&#39;</span>, <span class="st">&#39;EPSG:4326&#39;</span>)
iface.addVectorLayer(uri, <span class="st">&#39;trees&#39;</span>, <span class="st">&#39;delimitedtext&#39;</span>)</code></pre></div>
<p><img src="images/pyqgis/vectorlayer.png" style="display: block; margin: auto;" /></p>
</div>
<div id="adding-raster-layers" class="section level3">
<h3>Adding Raster Layers</h3>
<p><code>iface.addRasterLayer()</code> will not give you control on where the layer will be inserted in the layer tree. We can instead use <code>QgsLayerTree</code> class to insert the layer at an appropriate place.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)

filename <span class="op">=</span> <span class="st">&#39;sf.gpkg:srtm&#39;</span>
uri <span class="op">=</span> <span class="st">&#39;GPKG:&#39;</span> <span class="op">+</span> data_dir <span class="op">+</span> filename
rlayer <span class="op">=</span> QgsRasterLayer(uri, <span class="st">&#39;srtm&#39;</span>, <span class="st">&#39;gdal&#39;</span>)
QgsProject.instance().addMapLayer(rlayer, <span class="va">False</span>)

rastergroup <span class="op">=</span> QgsLayerTreeGroup(<span class="st">&#39;raster layers&#39;</span>)
treelayer <span class="op">=</span> QgsLayerTreeLayer(rlayer)
rastergroup.insertChildNode(<span class="dv">0</span>, treelayer)

root <span class="op">=</span> QgsProject.instance().layerTreeRoot()
root.insertChildNode(<span class="dv">1</span>, rastergroup)</code></pre></div>
<p><img src="images/pyqgis/rasterlayer.png" style="display: block; margin: auto;" /></p>
</div>
<div id="searching-for-a-layer" class="section level3">
<h3>Searching for a layer</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">blocks <span class="op">=</span> QgsProject.instance().mapLayersByName(<span class="st">&#39;blocks&#39;</span>)[<span class="dv">0</span>]</code></pre></div>
</div>
<div id="turning-a-layer-onoff" class="section level3">
<h3>Turning a layer on/off</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">QgsProject.instance().layerTreeRoot().findLayer(blocks.<span class="bu">id</span>()).setItemVisibilityChecked(<span class="va">True</span>)</code></pre></div>
</div>
<div id="create-a-new-vector-layer" class="section level3">
<h3>Create a New Vector Layer</h3>
<p>A simple example showing how to create a point layer with 1 feature and 1 attribute. <a href="#fn6" class="footnoteRef" id="fnref6"><sup>6</sup></a></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">vlayer <span class="op">=</span> QgsVectorLayer(<span class="st">&#39;Point?crs=EPSG:4326&#39;</span>, <span class="st">&#39;point&#39;</span>, <span class="st">&#39;memory&#39;</span>)

provider <span class="op">=</span> vlayer.dataProvider()
provider.addAttributes([QgsField(<span class="st">&#39;name&#39;</span>, QVariant.String)])
vlayer.updateFields() 
f <span class="op">=</span> QgsFeature()
f.setGeometry(QgsGeometry.fromPointXY(QgsPointXY(<span class="op">-</span><span class="fl">122.41</span>, <span class="fl">37.77</span>)))
f.setAttributes([<span class="st">&#39;San Francisco&#39;</span>])
provider.addFeature(f)
vlayer.updateExtents() 
QgsProject.instance().addMapLayer(vlayer)</code></pre></div>
</div>
<div id="saving-layers-to-disk" class="section level3">
<h3>Saving Layers to Disk</h3>
<p>Use the <code>QgsRasterFileWriter</code> or <code>QgsVectorFileWriter</code> classes for writing layers to disk. <a href="#fn7" class="footnoteRef" id="fnref7"><sup>7</sup></a></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)

options <span class="op">=</span> QgsVectorFileWriter.SaveVectorOptions()
options.actionOnExistingFile <span class="op">=</span> QgsVectorFileWriter.CreateOrOverwriteLayer 
options.layerName <span class="op">=</span> <span class="st">&#39;point&#39;</span>

filename <span class="op">=</span> <span class="st">&#39;sf.gpkg&#39;</span>
path <span class="op">=</span> os.path.join(data_dir, filename)
QgsVectorFileWriter.writeAsVectorFormat(vlayer, path, options)</code></pre></div>
</div>
</div>
<div id="symbology-and-labeling" class="section level2">
<h2>Symbology and Labeling</h2>
<p><img src="images/pyqgis/styling.png" style="display: block; margin: auto;" /></p>
<div id="displaying-a-label-with-a-background-color" class="section level3">
<h3>Displaying a label with a background color</h3>
<p>This is a vast topic, but you can get a taste of the flexibility offered by the API to control all aspects of labeling. Notice the class name <code>QgsPalLayerSettings</code> - this is because QGIS uses a labeling library called <a href="http://pal.heig-vd.ch/index.php?page=about-pal">PAL</a> for labels. The code snippet below shows how to create a label for a point layer with a background color. <a href="#fn8" class="footnoteRef" id="fnref8"><sup>8</sup></a></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">vlayer <span class="op">=</span> QgsProject.instance().mapLayersByName(<span class="st">&#39;point&#39;</span>)[<span class="dv">0</span>]
symbol <span class="op">=</span> QgsMarkerSymbol.createSimple({<span class="st">&#39;name&#39;</span>: <span class="st">&#39;square&#39;</span>, <span class="st">&#39;color&#39;</span>: <span class="st">&#39;red&#39;</span>})
vlayer.renderer().setSymbol(symbol)

label_settings <span class="op">=</span> QgsPalLayerSettings()
<span class="co">#label_settings.drawBackground = True</span>
label_settings.fieldName <span class="op">=</span> <span class="st">&#39;name&#39;</span>

text_format <span class="op">=</span> QgsTextFormat()
background_color <span class="op">=</span> QgsTextBackgroundSettings()
background_color.setFillColor(QColor(<span class="st">&#39;white&#39;</span>))
background_color.setEnabled(<span class="va">True</span>)
text_format.setBackground(background_color )
label_settings.setFormat(text_format)

vlayer.setLabeling(QgsVectorLayerSimpleLabeling(label_settings))
vlayer.setLabelsEnabled(<span class="va">True</span>)
vlayer.triggerRepaint()</code></pre></div>
<p><img src="images/pyqgis/label.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="processing" class="section level2">
<h2>Processing</h2>
<p>While the PyQGIS API providers many functions to work with layers, features, attributes and geometry - it is a much better practice to use the built-in processing algorithms to alter the layers or do any analysis. This will give you better performance and result in much lesser code. Here are some examples on how to use processing algorithms from Python to do vector and raster layer editing.</p>
<p><img src="images/pyqgis/processing.png" style="display: block; margin: auto;" /></p>
<div id="get-minmax-value-from-a-raster-layer" class="section level3">
<h3>Get min/max value from a Raster Layer</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)

filename <span class="op">=</span> <span class="st">&#39;sf.gpkg:srtm&#39;</span>
uri <span class="op">=</span> <span class="st">&#39;GPKG:&#39;</span> <span class="op">+</span> data_dir <span class="op">+</span> filename
rlayer <span class="op">=</span> QgsRasterLayer(uri, <span class="st">&#39;srtm&#39;</span>, <span class="st">&#39;gdal&#39;</span>)

results <span class="op">=</span> processing.run(<span class="st">&quot;qgis:rasterlayerstatistics&quot;</span>, 
    {<span class="st">&#39;INPUT&#39;</span>: rlayer,<span class="st">&#39;BAND&#39;</span>:<span class="dv">1</span>})
<span class="bu">print</span>(<span class="st">&#39;min:</span><span class="sc">{}</span><span class="st">,max:</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(results[<span class="st">&#39;MIN&#39;</span>], results[<span class="st">&#39;MAX&#39;</span>]))</code></pre></div>
</div>
<div id="create-a-hillshade-from-a-dem" class="section level3">
<h3>Create a hillshade from a DEM</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)

filename <span class="op">=</span> <span class="st">&#39;sf.gpkg:srtm&#39;</span>
uri <span class="op">=</span> <span class="st">&#39;GPKG:&#39;</span> <span class="op">+</span> data_dir <span class="op">+</span> filename
rlayer <span class="op">=</span> QgsRasterLayer(uri, <span class="st">&#39;srtm&#39;</span>, <span class="st">&#39;gdal&#39;</span>)
output_name <span class="op">=</span> <span class="st">&#39;hillshade.tif&#39;</span>
output_path <span class="op">=</span> os.path.join(data_dir, output_name)

results <span class="op">=</span> processing.runAndLoadResults(<span class="st">&quot;qgis:hillshade&quot;</span>, 
    {<span class="st">&#39;INPUT&#39;</span>: rlayer, 
    <span class="st">&#39;Z_FACTOR&#39;</span>:<span class="dv">2</span>,
    <span class="st">&#39;AZIMUTH&#39;</span>:<span class="dv">300</span>,
    <span class="st">&#39;V_ANGLE&#39;</span>:<span class="dv">40</span>,
    <span class="st">&#39;OUTPUT&#39;</span>: output_path})
<span class="bu">print</span>(results)</code></pre></div>
<p><img src="images/pyqgis/hillshade.png" style="display: block; margin: auto;" /></p>
</div>
<div id="edit-attribute-table-of-a-vector-layer" class="section level3">
<h3>Edit Attribute Table of a Vector Layer</h3>
<p>When you use processing, a new layer is created by each algorithm. This example shows, how to use processing to overwrite the original layer with the results of processing.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)

filename <span class="op">=</span> <span class="st">&#39;sf.gpkg|layername=blocks&#39;</span>
uri <span class="op">=</span> os.path.join(data_dir, filename)
blocks <span class="op">=</span> QgsVectorLayer(uri, <span class="st">&#39;blocks&#39;</span>, <span class="st">&#39;ogr&#39;</span>)

output <span class="op">=</span> processing.run(
    <span class="st">&quot;qgis:deletecolumn&quot;</span>, 
    {<span class="st">&#39;INPUT&#39;</span>: blocks,<span class="st">&#39;COLUMN&#39;</span>:[<span class="st">&#39;multigeom&#39;</span>],<span class="st">&#39;OUTPUT&#39;</span>:<span class="st">&#39;memory:&#39;</span>})
outputlayer <span class="op">=</span> output[<span class="st">&#39;OUTPUT&#39;</span>]

final <span class="op">=</span> processing.run(<span class="st">&quot;qgis:fieldcalculator&quot;</span>,
    {<span class="st">&#39;INPUT&#39;</span>:outputlayer,
    <span class="st">&#39;FIELD_NAME&#39;</span>:<span class="st">&#39;area&#39;</span>,
    <span class="st">&#39;FIELD_TYPE&#39;</span>:<span class="dv">0</span>,
    <span class="st">&#39;FIELD_LENGTH&#39;</span>:<span class="dv">10</span>,
    <span class="st">&#39;FIELD_PRECISION&#39;</span>:<span class="dv">3</span>,
    <span class="st">&#39;NEW_FIELD&#39;</span>:<span class="va">True</span>,
    <span class="st">&#39;FORMULA&#39;</span>:<span class="st">&#39;$area&#39;</span>,
    <span class="st">&#39;OUTPUT&#39;</span>:<span class="st">&#39;memory:&#39;</span>})
finallayer <span class="op">=</span> final[<span class="st">&#39;OUTPUT&#39;</span>]

options <span class="op">=</span> QgsVectorFileWriter.SaveVectorOptions()
<span class="co"># We overwrite the original layer</span>
options.layerName <span class="op">=</span> <span class="st">&#39;blocks&#39;</span>
options.actionOnExistingFile <span class="op">=</span> QgsVectorFileWriter.CreateOrOverwriteLayer 

output_file <span class="op">=</span> <span class="st">&#39;sf.gpkg&#39;</span>
output_path <span class="op">=</span> os.path.join(data_dir, output_file)
QgsVectorFileWriter.writeAsVectorFormat(finallayer, output_path, options)
QgsProject.instance().reloadAllLayers()</code></pre></div>
</div>
</div>
<div id="print-layouts" class="section level2">
<h2>Print Layouts</h2>
<p><img src="images/pyqgis/layout.png" style="display: block; margin: auto;" /></p>
<div id="creating-a-pdf-with-title" class="section level3">
<h3>Creating a PDF with Title</h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)

project <span class="op">=</span> QgsProject.instance()
extent <span class="op">=</span> QgsRectangle(<span class="op">-</span><span class="fl">122.52</span>, <span class="fl">37.71</span>, <span class="op">-</span><span class="fl">122.35</span>, <span class="fl">37.83</span>)

layout <span class="op">=</span> QgsPrintLayout(project)
layout.initializeDefaults()

pages <span class="op">=</span> layout.pageCollection()
pages.beginPageSizeChange()
page <span class="op">=</span> pages.page(<span class="dv">0</span>)
page.setPageSize(<span class="st">&#39;A4&#39;</span>,  QgsLayoutItemPage.Landscape)
pages.endPageSizeChange()
page_center <span class="op">=</span> page.pageSize().width() <span class="op">/</span> <span class="dv">2</span>


<span class="bu">map</span> <span class="op">=</span> QgsLayoutItemMap(layout)
<span class="bu">map</span>.setRect(QRectF(<span class="op">-</span><span class="fl">122.52</span>, <span class="fl">37.71</span>, <span class="op">-</span><span class="fl">122.35</span>, <span class="fl">37.83</span>))
<span class="bu">map</span>.setExtent(extent)
a4 <span class="op">=</span> QPageSize().size(QPageSize.A4, QPageSize.Millimeter)
<span class="bu">map</span>.attemptResize(QgsLayoutSize(a4.height(),  a4.width()))

layout.addItem(<span class="bu">map</span>)
title <span class="op">=</span> QgsLayoutItemLabel(layout)
title.setText(<span class="st">&#39;San Francisco&#39;</span>)
title.setFont(QFont(<span class="st">&#39;Arial&#39;</span>, <span class="dv">36</span>))
title.adjustSizeToText()
title.setReferencePoint(QgsLayoutItem.UpperMiddle)
title.attemptMove(QgsLayoutPoint(page_center, <span class="dv">10</span>))
layout.addItem(title)

output_file <span class="op">=</span> <span class="st">&#39;sf.pdf&#39;</span>
output_path <span class="op">=</span> os.path.join(data_dir, output_file)

exporter <span class="op">=</span> QgsLayoutExporter(layout)
exporter.exportToPdf(
    output_path, QgsLayoutExporter.PdfExportSettings())</code></pre></div>
<p><img src="images/pyqgis/layoutpdf.png" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="running-python-code-at-qgis-launch" class="section level1">
<h1>Running Python Code at QGIS Launch</h1>
<p>It is possible to execute some PyQGIS code every time QGIS starts. QGIS looks for a file named <code>startup.py</code> in the user’s Python home directory, and if it is found, executes it. This file is very useful in customizing QGIS interface with techniques learnt in the previous section.</p>
<p>If you are running multiple versions of QGIS, a very useful customization is to display the QGIS version number and name in the main window. The version name is stored in a global QGIS variable called <code>qgis_version</code>. We can read that variable and set the main window’s title with it. We connect this code to the signal <code>iface.initializationCompleted</code> signal when the main window is loaded.</p>
<p>Create a new file named <code>startup.py</code> with the following code. Note the imports at the top - including <code>iface</code>. When we ran the code snippets in the Python Console, we did not have to import any modules since they are done automatically when the console starts. For pyqgis scripts elsewhere, we have to explicitly import the modules (classes) that we want to use.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">from</span> qgis.utils <span class="im">import</span> iface
<span class="im">from</span> qgis.core <span class="im">import</span> QgsExpressionContextUtils

<span class="kw">def</span> customize():
    version <span class="op">=</span> QgsExpressionContextUtils.globalScope().variable(<span class="st">&#39;qgis_version&#39;</span>)
    title <span class="op">=</span> iface.mainWindow().windowTitle()
    iface.mainWindow().setWindowTitle(<span class="st">&#39;</span><span class="sc">{}</span><span class="st"> | </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(title,version))


iface.initializationCompleted.<span class="ex">connect</span>(customize)</code></pre></div>
<p>This file needs to be copied to the appropriate directory on your system. See <a href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/intro.html#running-python-code-when-qgis-starts">QGIS documentation</a> for details on the path for your platform.</p>
<p><img src="images/pyqgis/startup.png" style="display: block; margin: auto;" /></p>
<p>Once you copy the file at that location, restart QGIS. The title bar should now have the QGIS version name in it.</p>
<p><img src="images/pyqgis/customtitle.png" style="display: block; margin: auto;" /></p>
<div id="exercise" class="section level2">
<h2>Exercise</h2>
<p>Trying opening a new project in QGIS after you have restarted GIS with <code>startup.py</code> file in place. You will notice that the custom title with the version name is replaced with the default title.</p>
<p>Make a change to your <code>startup.py</code> so that the customization is applied even when a new project is loaded.</p>
</div>
</div>
<div id="creating-custom-python-actions" class="section level1">
<h1>Creating Custom Python Actions</h1>
<p><a href="https://docs.qgis.org/testing/en/docs/user_manual/working_with_vector/vector_properties.html#actions-properties">Actions</a> in QGIS provide a quick and easy way to trigger custom behavior in response to a user’s action - such as click on a feature in the canvas or an attribute value in the attribute table.</p>
<p>Actions provide an easy way to add custom behavior to QGIS without having to write plugins. Actions are integrated into the QGIS GUI and allow you to execute PyQGIS code on vector layers.</p>
<p>Actions are defined at the layer level. We will define an action for the <code>parcels</code> layer so when a user clicks on a parcel, all parcels that belong to the same block will be selected. The parcel layer has an attribute <strong>block_num</strong> that refers to the block that parcel belongs to.</p>
<p>Right-click the <code>parcels</code> layer and switch to <em>Actions</em> tab. Click <em>Add a new action</em> button. Select <strong>Python</strong> as the <em>Type</em>. Name the action as <strong>Select all parcels from the same block</strong>. This action is meant to be used for selecting features on the map canvas, so check the <strong>Canvas</strong> as the <em>Action Scope</em>. Enter the following code snippet in the <em>Action Text</em> and click <em>OK</em>. <a href="#fn9" class="footnoteRef" id="fnref9"><sup>9</sup></a></p>
<p><img src="images/pyqgis/action1.png" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">layer <span class="op">=</span> QgsProject.instance().mapLayer(<span class="st">&#39;[% @layer_id %]&#39;</span>)
layer.selectByExpression(<span class="st">&#39;&quot;block_num&quot;=</span><span class="ch">\&#39;</span><span class="st">[% block_num %]</span><span class="ch">\&#39;</span><span class="st">&#39;</span>)</code></pre></div>
<p>Back in the main QGIS window, enable the <code>parcels</code> layer. Click the <em>Run feature action</em> button from the <em>Attributes Toolbar</em> and select <strong>Select all parcels from the same block</strong>. With the action enabled, click on any parcel and you will see all parcels from the block get selected.</p>
<p><img src="images/pyqgis/action2.png" style="display: block; margin: auto;" /></p>
</div>
<div id="writing-python-console-scripts" class="section level1">
<h1>Writing Python Console Scripts</h1>
<p>We will now see how can we write python scripts, save them and run them within QGIS. We will also see examples of best practices - such as validating inputs, writing files safely and communicating the status to the user.</p>
<p>A goal of the script is to read the features of a selected vector layer, and write its attributes to a CSV file.</p>
<p>Open the Python Console and click the <em>Show Editor</em> button. Copy/paste the following code. Make sure to replace the username in the file path with your username. Click the <em>Save</em> button and save the file as <code>save_attributes_console.py</code>. The file can be saved anywhere.</p>
<p><img src="images/pyqgis/consolescript.png" style="display: block; margin: auto;" /></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)

output_name <span class="op">=</span> <span class="st">&#39;output.csv&#39;</span>
output_path <span class="op">=</span> os.path.join(data_dir, output_name)

layer <span class="op">=</span> iface.activeLayer()
<span class="co"># Check if a layer is selected</span>
<span class="cf">if</span> <span class="kw">not</span> layer:
    iface.messageBar().pushMessage(<span class="st">&#39;Please select a layer&#39;</span>,  level<span class="op">=</span>Qgis.Critical) 
<span class="co"># Check if the selected layer is a vector layer</span>
<span class="cf">if</span> layer.<span class="bu">type</span>() <span class="op">!=</span> QgsMapLayer.VectorLayer:
    iface.messageBar().pushMessage(<span class="st">&#39;Please select a vector layer&#39;</span>,  level<span class="op">=</span>Qgis.Critical)
    
<span class="co"># Using*with* statement which takes care of closing the files and handling errors</span>
<span class="cf">with</span> <span class="bu">open</span>(output_path, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> output_file:
    fieldnames <span class="op">=</span> [field.name() <span class="cf">for</span> field <span class="kw">in</span> layer.fields()]
    <span class="co">## write header</span>
    line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(name <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>
    output_file.write(line)
    <span class="co"># write feature attributes</span>
    <span class="cf">for</span> f <span class="kw">in</span> layer.getFeatures():
        line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(<span class="bu">str</span>(f[name]) <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>
        output_file.write(line)
iface.messageBar().pushMessage(
    <span class="st">&#39;Success:&#39;</span>, <span class="st">&#39;Output file written at &#39;</span> <span class="op">+</span> output_path, level<span class="op">=</span>Qgis.Success)</code></pre></div>
<p>You can run this script by clicking the <em>Run Script</em> button. The script will process the layer and write the file at the given location.</p>
<p><img src="images/pyqgis/consolescriptrun.png" style="display: block; margin: auto;" /></p>
</div>
<div id="writing-standalone-python-scripts" class="section level1">
<h1>Writing Standalone Python Scripts</h1>
<p>Having the python script run within QGIS is useful and desired most of the time. But there is a way to write python scripts that run on your system without QGIS being open. Let’s convert the script from the previous section to a standalone pyqgis script.</p>
<p>Create a new file with the code below and save it as <code>save_attributes_standalone.py</code>.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
<span class="im">from</span> qgis.core <span class="im">import</span> QgsApplication, QgsVectorLayer

qgs <span class="op">=</span> QgsApplication([], <span class="va">False</span>)
qgs.initQgis()

data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)

filename <span class="op">=</span> <span class="st">&#39;sf.gpkg|layername=zoning&#39;</span>
uri <span class="op">=</span> os.path.join(data_dir, filename)
layer <span class="op">=</span> QgsVectorLayer(uri, <span class="st">&#39;zoning&#39;</span>, <span class="st">&#39;ogr&#39;</span>)

output_name <span class="op">=</span> <span class="st">&#39;output.csv&#39;</span>
output_path <span class="op">=</span> os.path.join(data_dir, output_name)
    
<span class="cf">with</span> <span class="bu">open</span>(output_path, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> output_file:
    fieldnames <span class="op">=</span> [field.name() <span class="cf">for</span> field <span class="kw">in</span> layer.fields()]
    line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(name <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>
    output_file.write(line)
    <span class="cf">for</span> f <span class="kw">in</span> layer.getFeatures():
        line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(<span class="bu">str</span>(f[name]) <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>
        output_file.write(line)

<span class="bu">print</span>(<span class="st">&#39;Success: &#39;</span>, <span class="st">&#39;Output file written at&#39;</span> <span class="op">+</span> output_path)
qgs.exitQgis()</code></pre></div>
<p>You will notice that the script is almost exactly the same, but with a few notable changes. First there is the import statement at the top, to explicitly import the required modules. Next, we create an instance of the <code>QgsApplication</code> class and run <code>initQis()</code> method to load the QGIS data providers and layer registry. Finally we call <code>exitQgis()</code> to remove them from memory. Here we don’t have a way to take user input, so we hard-code the path to the input layer. Also we don’t have the QGIS GUI, we have no way of displaying the messages, so we remove those statements.</p>
<p>When you run the script within QGIS environment, all the paths to QGIS libraries and environment variables are already set and python is able to find and use it. But when you run the script outside of QGIS, you need to set them yourself. On Windows, you can do this using a batch file. Create a new file named <code>run_script.bat</code> with the following code. Make sure to save it in the same directory.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="at">@echo</span> off 

<span class="bu">set</span> OSGEO4W_ROOT<span class="op">=</span>C:<span class="op">\</span>OSGeo4W64
 
call <span class="st">&quot;%OSGEO4W_ROOT%</span><span class="ch">\b</span><span class="st">in\o4w_env.bat&quot;</span> 
call <span class="st">&quot;%OSGEO4W_ROOT%</span><span class="ch">\b</span><span class="st">in\qt5_env.bat&quot;</span> 
call <span class="st">&quot;%OSGEO4W_ROOT%</span><span class="ch">\b</span><span class="st">in\py3_env.bat&quot;</span> 
 
<span class="bu">set</span> PATH<span class="op">=%</span>OSGEO4W_ROOT<span class="op">%\</span><span class="bu">bin</span><span class="op">;%</span>OSGEO4W_ROOT<span class="op">%\</span>apps<span class="op">\</span>qgis<span class="op">-</span>ltr<span class="op">\</span><span class="bu">bin</span><span class="op">;</span>C:<span class="op">\</span>OSGeo4W64<span class="op">\</span>apps<span class="op">\</span>Qt5<span class="op">\</span><span class="bu">bin</span><span class="op">;%</span>PATH<span class="op">%</span>
<span class="bu">set</span> PYTHONPATH<span class="op">=%</span>OSGEO4W_ROOT<span class="op">%\</span>apps<span class="op">\</span>qgis<span class="op">-</span>ltr<span class="op">\</span>python<span class="op">;%</span>PYTHONPATH<span class="op">%</span>
<span class="bu">set</span> QGIS_PREFIX_PATH<span class="op">=%</span>OSGEO4W_ROOT<span class="op">%\</span>apps<span class="op">\</span>qgis<span class="op">-</span>ltr
<span class="bu">set</span> QT_QPA_PLATFORM_PLUGIN_PATH<span class="op">=%</span>OSGEO4W_ROOT<span class="op">%\</span>apps<span class="op">\</span>Qt5<span class="op">\</span>plugins

python3 save_attributes_standalone.py</code></pre></div>
<p>Open the command prompt, browse to the directory with the above files, type <code>run_script.bat</code> and press Enter.</p>
<blockquote>
<p>You can also just double-click the <code>run_script.bat</code> to run it, but you will not see any error or success messages. So it is always a good idea to run the script from the shell.</p>
</blockquote>
<p>The script will run and produce the output at the given path.</p>
<p><img src="images/pyqgis/standalonescript.png" style="display: block; margin: auto;" /></p>
</div>
<div id="processing-scripts" class="section level1">
<h1>Processing Scripts</h1>
<p>We already saw 2 different ways to write a Python script in QGIS. But there is another way - and it is the preferred approach to write scripts. Whenever you are writing a new script, consider using the built-in <strong>Processing Framework</strong>. This has several advantages. First, taking user input and writing output files is far easier because Processing Framework offers standardized user interface for these. Second, having your script in the Processing Toolbox also allows it to be part of any Processing Model or be run as a Batch job with multiple inputs. This tutorial will show how to write a custom python script that can be part of the Processing Framework in QGIS.</p>
<p>We will now see how the Python Console script can be converted to a Processing script. But first, a word on Python Classes.</p>
<div id="writing-a-python-class" class="section level2">
<h2>Writing a Python Class</h2>
<p>We have sen how to use a class from PyQt or PyQGIS libraries. But we have not written a new class. To write a Processing Script, we must write a new class. A new class is defined using the word <code>class</code>. All classes have a function called<code>__init__()</code>, which is always executed when a new object is being created. There is also the keyword <code>self</code> which refers to the current instance of the class.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">class</span> Hello:
  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, greeting):
    <span class="va">self</span>.greeting <span class="op">=</span> greeting

  <span class="kw">def</span> hello(<span class="va">self</span>):
    <span class="bu">print</span>(<span class="va">self</span>.greeting, <span class="st">&#39;World!&#39;</span>)

hi <span class="op">=</span> Hello(<span class="st">&#39;Hi&#39;</span>)
hi.hello()
hola <span class="op">=</span> Hello(<span class="st">&#39;Hola&#39;</span>)
hola.hello()</code></pre></div>
<p>As we saw, all PyQGIS and PyQt inherit from other classes. When using them, sometimes you will see the use of a function <code>super()</code>. Here <code>super</code> refers to the parent class and when you are using the child class, you need to initialize the parent class using this keyword. Let’s see this in action.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">class</span> Talk(Hello):
  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, language):
    <span class="cf">if</span> language <span class="op">==</span> <span class="st">&#39;English&#39;</span>:
      <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;Hi&#39;</span>)
    <span class="cf">elif</span> language <span class="op">==</span> <span class="st">&#39;Spanish&#39;</span>:
      <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;Hola&#39;</span>)
    <span class="cf">else</span>:
      <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&#39;Unsupported Language&#39;</span>)

t <span class="op">=</span> Talk(<span class="st">&#39;English&#39;</span>)
t.hello()
t <span class="op">=</span> Talk(<span class="st">&#39;Spanish&#39;</span>)
t.hello()</code></pre></div>
</div>
<div id="writing-a-processing-script" class="section level2">
<h2>Writing a Processing Script</h2>
<p>To create a new processing script, go to <strong>Processing → Processing Toolbox</strong>. Click the <em>Scripts</em> button and select <em>Create New Script..</em>.</p>
<p><img src="images/pyqgis/processingscriptnew.png" style="display: block; margin: auto;" /></p>
<p>Copy/paste the following code into the <em>Processing Script Editor</em>.</p>
<p><code>save_attributes_processing.py</code></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">from</span> PyQt5.QtCore <span class="im">import</span> QCoreApplication
<span class="im">from</span> qgis.core <span class="im">import</span> (QgsProcessing,
                       QgsProcessingAlgorithm,
                       QgsProcessingParameterFeatureSource,
                       QgsProcessingParameterFileDestination)


<span class="kw">class</span> SaveAttributesAlgorithm(QgsProcessingAlgorithm):
    <span class="co">&quot;&quot;&quot;Saves the attributes of a vector layer to a CSV file.&quot;&quot;&quot;</span>
    OUTPUT <span class="op">=</span> <span class="st">&#39;OUTPUT&#39;</span>
    INPUT <span class="op">=</span> <span class="st">&#39;INPUT&#39;</span>

    <span class="kw">def</span> initAlgorithm(<span class="va">self</span>, config<span class="op">=</span><span class="va">None</span>):
        <span class="va">self</span>.addParameter(
            QgsProcessingParameterFeatureSource(
                <span class="va">self</span>.INPUT,
                <span class="va">self</span>.tr(<span class="st">&#39;Input layer&#39;</span>),
                [QgsProcessing.TypeVectorAnyGeometry]
            )
        )

        <span class="co"># We add a file output of type CSV.</span>
        <span class="va">self</span>.addParameter(
            QgsProcessingParameterFileDestination(
                <span class="va">self</span>.OUTPUT,
                <span class="va">self</span>.tr(<span class="st">&#39;Output File&#39;</span>),
                <span class="st">&#39;CSV files (*.csv)&#39;</span>,
            )
        )

    <span class="kw">def</span> processAlgorithm(<span class="va">self</span>, parameters, context, feedback):
        source <span class="op">=</span> <span class="va">self</span>.parameterAsSource(parameters, <span class="va">self</span>.INPUT, context)
        csv <span class="op">=</span> <span class="va">self</span>.parameterAsFileOutput(parameters, <span class="va">self</span>.OUTPUT, context)

        fieldnames <span class="op">=</span> [field.name() <span class="cf">for</span> field <span class="kw">in</span> source.fields()]

        <span class="co"># Compute the number of steps to display within the progress bar and</span>
        <span class="co"># get features from source</span>
        total <span class="op">=</span> <span class="fl">100.0</span> <span class="op">/</span> source.featureCount() <span class="cf">if</span> source.featureCount() <span class="cf">else</span> <span class="dv">0</span>
        features <span class="op">=</span> source.getFeatures()

        <span class="cf">with</span> <span class="bu">open</span>(csv, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> output_file:
          <span class="co"># write header</span>
          line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(name <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>
          output_file.write(line)
          <span class="cf">for</span> current, f <span class="kw">in</span> <span class="bu">enumerate</span>(features):
              <span class="co"># Stop the algorithm if cancel button has been clicked</span>
              <span class="cf">if</span> feedback.isCanceled():
                  <span class="cf">break</span>

              <span class="co"># Add a feature in the sink</span>
              line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(<span class="bu">str</span>(f[name]) <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>
              output_file.write(line)

              <span class="co"># Update the progress bar</span>
              feedback.setProgress(<span class="bu">int</span>(current <span class="op">*</span> total))

        <span class="cf">return</span> {<span class="va">self</span>.OUTPUT: csv}

    <span class="kw">def</span> name(<span class="va">self</span>):
        <span class="cf">return</span> <span class="st">&#39;save_attributes&#39;</span>

    <span class="kw">def</span> displayName(<span class="va">self</span>):
        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="st">&#39;Save Attributes As CSV&#39;</span>)

    <span class="kw">def</span> group(<span class="va">self</span>):
        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="va">self</span>.groupId())

    <span class="kw">def</span> groupId(<span class="va">self</span>):
        <span class="cf">return</span> <span class="st">&#39;&#39;</span>

    <span class="kw">def</span> tr(<span class="va">self</span>, string):
        <span class="cf">return</span> QCoreApplication.translate(<span class="st">&#39;Processing&#39;</span>, string)

    <span class="kw">def</span> createInstance(<span class="va">self</span>):
        <span class="cf">return</span> SaveAttributesAlgorithm()</code></pre></div>
<p><img src="images/pyqgis/processingscriptwrite.png" style="display: block; margin: auto;" /></p>
<p>By now, you must be familiar with the code in the <code>processAlgorithm()</code> method. This method contains the main logic of the script that gets executed when the user clicks the <em>Run</em> button. Here we are creating a new class called <code>SaveAttributesAlgorithm</code>. As this is a processing script, we must inherit from the <code>QgsProcessingAlgorithm</code> class. The <code>initAlgorithm()</code> method is called to set-up the inputs and the outputs. There are other methods that set the algorithm name and group.</p>
<p>Click the <em>Save Script</em> button and save the script as <code>save_attributes_algorithm.py</code>. This script must be saved inside the <code>{profile foler}/processing/scripts/</code> directory so it can be loaded when QGIS starts.</p>
<p>Once saved, the algorithm will appear in the <em>Processing Toolbox</em> under <strong>Scripts → Save Attributes As CSV</strong>. Double-click to launch it. You will see the standard processing algorithm dialog where the user can select inputs and outputs easily. Progress bar is shown correctly and the execution also stops if the user presses the <em>Cancel</em> button. If the large is large and the algorithm would take time to process it, the user can also close the window and the algorithm will continue to run in the background.</p>
<p><img src="images/pyqgis/processingscriptrun.png" style="display: block; margin: auto;" /></p>
</div>
<div id="simplifying-processing-scripts" class="section level2">
<h2>Simplifying Processing Scripts</h2>
<p>The Processing Framework providers a simpler way to write processing scripts by using the <code>@alg</code> decorator. Using this approach, you are able to remove a lot of <em>boilerplate</em> code and focus on just writing the main algorithm function. There are some limitations of this approach - the main one being that scripts written using the <code>@alg</code> decorator cannot be used in plugins. But if your goal is to create a processing scripts, this is a much simpler and recommended style. But before we see how to write such scripts, you need to understand <em>Python Decorators</em>.</p>
<blockquote>
<p>Note: the <code>@alg</code> decorator is available only from QGIS 3.6 onwards.</p>
</blockquote>
<div id="understanding-python-decorators" class="section level3">
<h3>Understanding Python Decorators</h3>
<p>Decorators are functions that take a function as an input and returns a modified function. Decorators are an easy way to inject additional functionality into existing functions without a lot of repeated code. To decorate a function, you use the <code>@decorator</code> syntax above the function definition. Once decorated, the original function gets modified with the decorator function.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> fancify(normal_function):
    
    <span class="kw">def</span> fancy(<span class="op">*</span>args, <span class="op">**</span>kwargs):
        val <span class="op">=</span> normal_function(<span class="op">*</span>args, <span class="op">**</span>kwargs)
        <span class="cf">return</span> <span class="st">&#39;*****&#39;</span> <span class="op">+</span> val <span class="op">+</span> <span class="st">&#39;*****&#39;</span>
        
    <span class="cf">return</span> fancy
    
<span class="kw">def</span> hello(name):
    <span class="cf">return</span> <span class="st">&#39;Hello &#39;</span> <span class="op">+</span> name
    
<span class="bu">print</span>(hello(<span class="st">&#39;World&#39;</span>))

<span class="at">@fancify</span>
<span class="kw">def</span> hello(name):
    <span class="cf">return</span> <span class="st">&#39;Hello &#39;</span> <span class="op">+</span> name
    
<span class="bu">print</span>(hello(<span class="st">&#39;World&#39;</span>))</code></pre></div>
</div>
<div id="writing-a-processing-script-with-decorators" class="section level3">
<h3>Writing a Processing Script with Decorators</h3>
<p>Let’s modify the <code>save_attributes_algorithm.py</code> script to use the built-in <code>@alg</code> decorator. Locate the script in <em>Processing Toolbox</em> under <strong>Scripts → Save Attributes As CSV</strong>. Right-click on it and select <em>Edit Script…</em>. Replace all the code in the <em>Processing Script Editor</em> with the following and click the <em>Save Script</em> button</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">from</span> qgis.processing <span class="im">import</span> alg

<span class="at">@alg</span>(name<span class="op">=</span><span class="st">&#39;save_attributes&#39;</span>, label<span class="op">=</span><span class="st">&#39;Save Attributes As CSV&#39;</span>,
    group<span class="op">=</span><span class="st">&#39;&#39;</span>, group_label<span class="op">=</span><span class="st">&#39;&#39;</span>)
<span class="at">@alg.input</span>(<span class="bu">type</span><span class="op">=</span>alg.SOURCE, name<span class="op">=</span><span class="st">&#39;INPUT&#39;</span>, label<span class="op">=</span><span class="st">&#39;Input Layer&#39;</span>)
<span class="at">@alg.input</span>(<span class="bu">type</span><span class="op">=</span>alg.FILE_DEST, name<span class="op">=</span><span class="st">&#39;OUTPUT&#39;</span>, label<span class="op">=</span><span class="st">&#39;Output File&#39;</span>)
<span class="kw">def</span> processAlgorithm(instance, parameters, context, feedback, inputs):
    <span class="co">&quot;&quot;&quot;Saves the attributes of a vector layer to a CSV file.&quot;&quot;&quot;</span>
    source <span class="op">=</span> instance.parameterAsSource(parameters, <span class="st">&#39;INPUT&#39;</span>, context)
    csv <span class="op">=</span> instance.parameterAsFileOutput(parameters, <span class="st">&#39;OUTPUT&#39;</span>, context)

    fieldnames <span class="op">=</span> [field.name() <span class="cf">for</span> field <span class="kw">in</span> source.fields()]

    <span class="co"># Compute the number of steps to display within the progress bar and</span>
    <span class="co"># get features from source</span>
    total <span class="op">=</span> <span class="fl">100.0</span> <span class="op">/</span> source.featureCount() <span class="cf">if</span> source.featureCount() <span class="cf">else</span> <span class="dv">0</span>
    features <span class="op">=</span> source.getFeatures()

    <span class="cf">with</span> <span class="bu">open</span>(csv, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> output_file:
      <span class="co"># write header</span>
      line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(name <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>
      output_file.write(line)
      <span class="cf">for</span> current, f <span class="kw">in</span> <span class="bu">enumerate</span>(features):
          <span class="co"># Stop the algorithm if cancel button has been clicked</span>
          <span class="cf">if</span> feedback.isCanceled():
              <span class="cf">break</span>

          <span class="co"># Add a feature in the sink</span>
          line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(<span class="bu">str</span>(f[name]) <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>
          output_file.write(line)

          <span class="co"># Update the progress bar</span>
          feedback.setProgress(<span class="bu">int</span>(current <span class="op">*</span> total))

    <span class="cf">return</span> {<span class="st">&#39;OUTPUT&#39;</span>: csv}</code></pre></div>
<p>You can run the script and see that the behavior is almost identical but the code is much simpler. The code uses the <code>@alg</code> decorator for defining algorithm name, group, inputs and outputs in a more concise way.</p>
<p>Another important thing to note is that to create a processing algorithm, one must create a class that inherits from <code>QgsProcessingAlgorithm</code>. When you write a class, you refer to the current instance of the class with the keyword <code>self</code>. Here you are just writing a function, and the decorator will create a class for you. So we are using a parameter named <code>instance</code>. When the decorator will create a class, the referene to the instance will be passed on to our function as this parameter.</p>
</div>
</div>
</div>
<div id="writing-plugins" class="section level1">
<h1>Writing Plugins</h1>
<p>Plugins are a great way to extend the functionality of QGIS. You can write plugins using Python that can range from adding a simple button to sophisticated tool-kits. There are 2 broad categories of python plugins - Processing Plugins and GUI Plugins. We will cover both in this section.</p>
<p>There is a plugin named <a href="https://plugins.qgis.org/plugins/pluginbuilder/">Plugin Builder</a> that can help you generate a starter plugin. I have published step-by-step instructions for both <a href="https://www.qgistutorials.com/en/docs/3/building_a_python_plugin.html">GUI plugins</a> and <a href="https://www.qgistutorials.com/en/docs/3/processing_python_plugin.html">Processing Plugins</a> using the Plugin Builder method. While this method gives you an easy way to have a functional plugin, it is not the ideal way to learn plugin development. I prefer starting from a minimal template and adding elements as and when needed. Here we will learn the basics of plugin framework using a minimal plugin and learn how to add various element to make it a full plugin.</p>
<div id="a-minimal-plugin" class="section level2">
<h2>A Minimal Plugin</h2>
<p>Plugins are much more integrated into the QGIS system than Python Scripts. They are managed by <strong>Plugin Manager</strong> and are initialized when QGIS starts. To understand the required structure, let’s see what a minimal plugin looks like. You can learn more about this structure at <a href="https://github.com/wonder-sk/qgis-minimal-plugin">QGIS Minimalist Plugin Skeleton</a>.</p>
<p>We will be the same script for saving attributes of a vector layer and convert it to a plugin. The first requirement for plugins is a file called <code>metadata.txt</code>. This file contains general info, version, name and some other metadata used by plugins website and plugin manager.</p>
<p><code>metadata.txt</code></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">[general]
name<span class="op">=</span>Save Attributes
description<span class="op">=</span>This plugin saves the attributes of the selected vector layer <span class="im">as</span> a CSV <span class="bu">file</span>
version<span class="op">=</span><span class="fl">1.0</span>
qgisMinimumVersion<span class="op">=</span><span class="fl">3.0</span>
author<span class="op">=</span>Ujaval Gandhi
email<span class="op">=</span>ujaval<span class="op">@</span>spatialthoughts.com</code></pre></div>
<p>Second file is called <code>__init__.py</code> which is the starting point of the plugin. It has to have the classFactory() method that returns the instance of the main plugin class.</p>
<p><code>__init__.py</code></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">from</span> .save_attributes <span class="im">import</span> SaveAttributesPlugin

<span class="kw">def</span> classFactory(iface):
    <span class="cf">return</span> SaveAttributesPlugin(iface)</code></pre></div>
<p>Third is the file that contains the main logic of the plugin. It must have <code>__init__()</code> method that gives the plugin access to the QGIS Interface (iface). The <code>initGui()</code> method is called when the plugin is loaded and <code>unload()</code> method which is called when the plugin is unloaded. For now, we are creating a minimal plugin that just add a button and a menu entry that displays message when clicked.</p>
<p><code>save_attributes.py</code></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
<span class="im">import</span> sys
<span class="im">import</span> inspect
<span class="im">from</span> PyQt5.QtWidgets <span class="im">import</span> QAction
<span class="im">from</span> PyQt5.QtGui <span class="im">import</span> QIcon

cmd_folder <span class="op">=</span> os.path.split(inspect.getfile(inspect.currentframe()))[<span class="dv">0</span>]

<span class="kw">class</span> SaveAttributesPlugin:
    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, iface):
        <span class="va">self</span>.iface <span class="op">=</span> iface

    <span class="kw">def</span> initGui(<span class="va">self</span>):
      icon <span class="op">=</span> os.path.join(os.path.join(cmd_folder, <span class="st">&#39;logo.png&#39;</span>))
      <span class="va">self</span>.action <span class="op">=</span> QAction(QIcon(icon), <span class="st">&#39;Save Attributes as CSV&#39;</span>, <span class="va">self</span>.iface.mainWindow())
      <span class="va">self</span>.action.triggered.<span class="ex">connect</span>(<span class="va">self</span>.run)
      <span class="va">self</span>.iface.addPluginToMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)
      <span class="va">self</span>.iface.addToolBarIcon(<span class="va">self</span>.action)

    <span class="kw">def</span> unload(<span class="va">self</span>):
      <span class="va">self</span>.iface.removeToolBarIcon(<span class="va">self</span>.action)
      <span class="va">self</span>.iface.removePluginMenu(<span class="st">&#39;&amp;SaveAttributes&#39;</span>, <span class="va">self</span>.action)  
      <span class="kw">del</span> <span class="va">self</span>.action

    <span class="kw">def</span> run(<span class="va">self</span>):
      <span class="va">self</span>.iface.messageBar().pushMessage(<span class="st">&#39;Hello from Plugin&#39;</span>)</code></pre></div>
<p>Create these 3 files and put them in a folder named <code>save_attributes</code>. Copy the <code>logo.png</code> file from <code>&lt;home folder&gt;/Downloads/pyqgis_in_a_day/logo.png</code> to this folder. Copy the folder to the python plugins directory at <code>{profile folder}/python/plugins</code>.</p>
<p><img src="images/pyqgis/pluginminimalfiles.png" style="display: block; margin: auto;" /></p>
<p>Restart QGIS. Go to <strong>Plugins → Manage and Install plugins… → Installed</strong> and enable the <strong>Save Attributes</strong> plugin. You will see the menu entry and the toolbar icon from the plugin.</p>
<p><img src="images/pyqgis/pluginminimalshow.png" style="display: block; margin: auto;" /></p>
<div id="exercise-1" class="section level3">
<h3>Exercise</h3>
<p>Take the minimal plugin template from above and build a new plugin called ‘Show Time’. This plugin will add a button to the Plugin Toolbar which will display the current time when clicked. The code to add such a button is already covered in the <strong>Add a button to a toolbar</strong> section.</p>
</div>
</div>
<div id="processing-plugin" class="section level2">
<h2>Processing Plugin</h2>
<p>The new and preferred way to write plugins in QGIS is using the Processing Framework. It removes the need for you to design the user interface. The resulting plugin integrates seamlessly in the Processing Toolbox and is inoperable with other processing algorithms.</p>
<p>Let’s take the minimal plugin and see what is required to make it a functional processing plugin. We need 2 additional files. One to define the processing algorithm and another to define a new processing provider.</p>
<p>The processing algorithm file is identical to the script we wrote earlier. Create a new file called <code>save_attributes_algorithm.py</code> with the contents of the processing script from the ‘Writing a Processing Script’ section of this document.</p>
<p>Next, we need to define a new processing provider. Create a new file <code>save_attributes_provider.py</code> with the following content.</p>
<p><code>save_attributes_provider.py</code></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
<span class="im">import</span> inspect
<span class="im">from</span> PyQt5.QtGui <span class="im">import</span> QIcon

<span class="im">from</span> qgis.core <span class="im">import</span> QgsProcessingProvider
<span class="im">from</span> .save_attributes_algorithm <span class="im">import</span> SaveAttributesAlgorithm


<span class="kw">class</span> SaveAttributesProvider(QgsProcessingProvider):

    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):
        QgsProcessingProvider.<span class="fu">__init__</span>(<span class="va">self</span>)

    <span class="kw">def</span> unload(<span class="va">self</span>):
        <span class="cf">pass</span>

    <span class="kw">def</span> loadAlgorithms(<span class="va">self</span>):
        <span class="va">self</span>.addAlgorithm(SaveAttributesAlgorithm())

    <span class="kw">def</span> <span class="bu">id</span>(<span class="va">self</span>):
        <span class="cf">return</span> <span class="st">&#39;save_attributes&#39;</span>

    <span class="kw">def</span> name(<span class="va">self</span>):
        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="st">&#39;Save Attributes&#39;</span>)

    <span class="kw">def</span> icon(<span class="va">self</span>):
        cmd_folder <span class="op">=</span> os.path.split(inspect.getfile(inspect.currentframe()))[<span class="dv">0</span>]
        icon <span class="op">=</span> QIcon(os.path.join(os.path.join(cmd_folder, <span class="st">&#39;logo.png&#39;</span>)))
        <span class="cf">return</span> icon

    <span class="kw">def</span> longName(<span class="va">self</span>):
        <span class="cf">return</span> <span class="va">self</span>.name()</code></pre></div>
<p>We now make changes to the existing <code>save_attributes.py</code> file to import and initialize the new processing provider. Change the contents of the file to the following</p>
<p><code>save_attributes.py</code></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
<span class="im">import</span> sys
<span class="im">import</span> inspect
<span class="im">from</span> PyQt5.QtWidgets <span class="im">import</span> QAction
<span class="im">from</span> PyQt5.QtGui <span class="im">import</span> QIcon

<span class="im">from</span> qgis.core <span class="im">import</span> QgsProcessingAlgorithm, QgsApplication
<span class="im">import</span> processing
<span class="im">from</span> .save_attributes_provider <span class="im">import</span> SaveAttributesProvider


cmd_folder <span class="op">=</span> os.path.split(inspect.getfile(inspect.currentframe()))[<span class="dv">0</span>]

<span class="kw">class</span> SaveAttributesPlugin:
    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, iface):
        <span class="va">self</span>.iface <span class="op">=</span> iface

    <span class="kw">def</span> initProcessing(<span class="va">self</span>):
      <span class="va">self</span>.provider <span class="op">=</span> SaveAttributesProvider()
      QgsApplication.processingRegistry().addProvider(<span class="va">self</span>.provider)
        
    <span class="kw">def</span> initGui(<span class="va">self</span>):
      <span class="va">self</span>.initProcessing()
      icon <span class="op">=</span> os.path.join(os.path.join(cmd_folder, <span class="st">&#39;logo.png&#39;</span>))
      <span class="va">self</span>.action <span class="op">=</span> QAction(QIcon(icon), <span class="st">&#39;Save Attributes as CSV&#39;</span>, <span class="va">self</span>.iface.mainWindow())
      <span class="va">self</span>.action.triggered.<span class="ex">connect</span>(<span class="va">self</span>.run)
      <span class="va">self</span>.iface.addPluginToMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)
      <span class="va">self</span>.iface.addToolBarIcon(<span class="va">self</span>.action)

    <span class="kw">def</span> unload(<span class="va">self</span>):
      QgsApplication.processingRegistry().removeProvider(<span class="va">self</span>.provider)
      <span class="va">self</span>.iface.removeToolBarIcon(<span class="va">self</span>.action)
      <span class="va">self</span>.iface.removePluginMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)  
      <span class="kw">del</span> <span class="va">self</span>.action

    <span class="kw">def</span> run(<span class="va">self</span>):
      processing.execAlgorithmDialog(<span class="st">&#39;save_attributes:save_attributes&#39;</span>)</code></pre></div>
<p>The plugin folder should look like below.</p>
<p><img src="images/pyqgis/pluginprocessingfiles.png" style="display: block; margin: auto;" /></p>
<p>Now let’s reload the plugin and see what it looks like. This is a helper plugin which allows iterative development of plugins. Using this plugin, you can change your plugin code and have it reflected in QGIS without having to restart QGIS every time. Find and install the <strong>Plugin Reloader</strong> plugin. Once installed, go to <strong>Plugin → Plugin Reloader → Choose a plugin to be reloaded</strong>. Select <code>save_attributes</code> in the Configure Plugin reloader dialog.</p>
<p><img src="images/pyqgis/pluginprocessingreload.png" style="display: block; margin: auto;" /></p>
<p>Once reloaded, you can click on the toolbar button or <strong>Plugin → Save Attributes → Save Attributes As CSV</strong> to launch the processing algorithm.</p>
<p><img src="images/pyqgis/pluginprocessingrun.png" style="display: block; margin: auto;" /></p>
</div>
<div id="gui-plugin" class="section level2">
<h2>GUI Plugin</h2>
<p>There are times when the plugin needs to modify the QGIS GUI or add complex widgets. In such cases, you will have to build and program the widgets using PyQt and PyQGIS APIs. We will now see how can we design and program a dialog box to the <em>Minimal plugin</em> and convert it to a GUI plugin.</p>
<p>Open <strong>Qt Designer</strong> from <code>C:\OSGeo4W\bin\qgis-designer.bat</code></p>
<p>Select the <em>Dialog with Buttons Bottom</em> and click <em>Create</em>.</p>
<p><img src="images/pyqgis/designercreate.png" style="display: block; margin: auto;" /></p>
<p>This is a basic dialog box that we will modify later. Let’s save it for now. Name the file as <code>save_attributes_dialog.ui</code> and save it in the plugin directory <code>{profile_folder}\python\plugins\save_attributes\</code></p>
<p><img src="images/pyqgis/designersave.png" style="display: block; margin: auto;" /></p>
<p>We need to create a new file that reads this <code>.ui</code> file and creates a PyQt QDialog() object from it. Create a new <code>save_attributes_dialog.py</code> in the plugin folder with the following content.</p>
<p><code>save_attributes_dialog.py</code></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os

<span class="im">from</span> PyQt5 <span class="im">import</span> uic
<span class="im">from</span> PyQt5 <span class="im">import</span> QtWidgets

FORM_CLASS, _ <span class="op">=</span> uic.loadUiType(os.path.join(
    os.path.dirname(<span class="va">__file__</span>), <span class="st">&#39;save_attributes_dialog.ui&#39;</span>))


<span class="kw">class</span> SaveAttributesDialog(QtWidgets.QDialog, FORM_CLASS):
    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, parent<span class="op">=</span><span class="va">None</span>):
        <span class="bu">super</span>(SaveAttributesDialog, <span class="va">self</span>).<span class="fu">__init__</span>(parent)
        <span class="va">self</span>.setupUi(<span class="va">self</span>)</code></pre></div>
<p>Now we can import this into the main plugin file <code>save_attributes.py</code> and initialize the dialog. Replace the content of the file with the following.</p>
<p><code>save_attributes.py</code></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
<span class="im">import</span> sys
<span class="im">import</span> inspect
<span class="im">from</span> PyQt5.QtWidgets <span class="im">import</span> QAction
<span class="im">from</span> PyQt5.QtGui <span class="im">import</span> QIcon
<span class="im">from</span> .save_attributes_dialog <span class="im">import</span> SaveAttributesDialog

cmd_folder <span class="op">=</span> os.path.split(inspect.getfile(inspect.currentframe()))[<span class="dv">0</span>]

<span class="kw">class</span> SaveAttributesPlugin:
    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, iface):
        <span class="va">self</span>.iface <span class="op">=</span> iface

    <span class="kw">def</span> initGui(<span class="va">self</span>):
      icon <span class="op">=</span> os.path.join(os.path.join(cmd_folder, <span class="st">&#39;logo.png&#39;</span>))
      <span class="va">self</span>.action <span class="op">=</span> QAction(QIcon(icon), <span class="st">&#39;Save Attributes as CSV&#39;</span>, <span class="va">self</span>.iface.mainWindow())
      <span class="va">self</span>.action.triggered.<span class="ex">connect</span>(<span class="va">self</span>.run)
      <span class="va">self</span>.iface.addPluginToMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)
      <span class="va">self</span>.iface.addToolBarIcon(<span class="va">self</span>.action)
      <span class="va">self</span>.first_start <span class="op">=</span> <span class="va">True</span>

    <span class="kw">def</span> unload(<span class="va">self</span>):
      <span class="va">self</span>.iface.removeToolBarIcon(<span class="va">self</span>.action)
      <span class="va">self</span>.iface.removePluginMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)  
      <span class="kw">del</span> <span class="va">self</span>.action

    <span class="kw">def</span> run(<span class="va">self</span>):
      <span class="cf">if</span> <span class="va">self</span>.first_start <span class="op">==</span> <span class="va">True</span>:
        <span class="va">self</span>.first_start <span class="op">=</span> <span class="va">False</span>
        <span class="va">self</span>.dlg <span class="op">=</span> SaveAttributesDialog()
        
      <span class="va">self</span>.dlg.show()</code></pre></div>
<p>Back in QGIS, reload the plugin. Click the <em>Save Attributes As CSV</em> toolbar button. You will see the UI dialog appear.</p>
<p><img src="images/pyqgis/dialogfirstload.png" style="display: block; margin: auto;" /></p>
<p>Now we can go back to Qt Designer and complete the UI design. You can drag various elements like <em>label</em>, <em>Combo Box</em>, <em>Line Edit</em> and <em>Push Button</em> as shown below. Once complete, save the dialog. Note the name of the object names of various widgets. We will use these names to program these elements.</p>
<p><img src="images/pyqgis/designercomplete.png" style="display: block; margin: auto;" /></p>
<p>The main file <code>save_attributes.py</code> needs to be changed. Most importantly we need to add a new <code>select_output_file()</code> method and connect it to the <em>…</em> button. Rest of the code should be familiar from the previous sections.</p>
<p><code>save_attributes.py</code></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
<span class="im">import</span> sys
<span class="im">import</span> inspect
<span class="im">from</span> PyQt5.QtGui <span class="im">import</span> QIcon
<span class="im">from</span> PyQt5.QtWidgets <span class="im">import</span> QAction, QFileDialog
<span class="im">from</span> qgis.core <span class="im">import</span> QgsProject, Qgis, QgsMapLayer
<span class="im">from</span> .save_attributes_dialog <span class="im">import</span> SaveAttributesDialog

cmd_folder <span class="op">=</span> os.path.split(inspect.getfile(inspect.currentframe()))[<span class="dv">0</span>]

<span class="kw">class</span> SaveAttributesPlugin:
    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, iface):
        <span class="va">self</span>.iface <span class="op">=</span> iface

    <span class="kw">def</span> initGui(<span class="va">self</span>):
      icon <span class="op">=</span> os.path.join(os.path.join(cmd_folder, <span class="st">&#39;logo.png&#39;</span>))
      <span class="va">self</span>.action <span class="op">=</span> QAction(QIcon(icon), <span class="st">&#39;Save Attributes as CSV&#39;</span>, <span class="va">self</span>.iface.mainWindow())
      <span class="va">self</span>.action.triggered.<span class="ex">connect</span>(<span class="va">self</span>.run)
      <span class="va">self</span>.iface.addPluginToMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)
      <span class="va">self</span>.iface.addToolBarIcon(<span class="va">self</span>.action)
      <span class="va">self</span>.first_start <span class="op">=</span> <span class="va">True</span>

    <span class="kw">def</span> unload(<span class="va">self</span>):
      <span class="va">self</span>.iface.removeToolBarIcon(<span class="va">self</span>.action)
      <span class="va">self</span>.iface.removePluginMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)  
      <span class="kw">del</span> <span class="va">self</span>.action

    <span class="kw">def</span> select_output_file(<span class="va">self</span>):
      filename, _filter <span class="op">=</span> QFileDialog.getSaveFileName(
        <span class="va">self</span>.dlg, <span class="st">&quot;Select   output file &quot;</span>,<span class="st">&quot;&quot;</span>, <span class="st">&#39;*.csv&#39;</span>)
      <span class="va">self</span>.dlg.lineEdit.setText(filename)
      
    <span class="kw">def</span> run(<span class="va">self</span>):
      <span class="cf">if</span> <span class="va">self</span>.first_start <span class="op">==</span> <span class="va">True</span>:
        <span class="va">self</span>.first_start <span class="op">=</span> <span class="va">False</span>
        <span class="va">self</span>.dlg <span class="op">=</span> SaveAttributesDialog()
        <span class="va">self</span>.dlg.pushButton.clicked.<span class="ex">connect</span>(<span class="va">self</span>.select_output_file)

        
      layers <span class="op">=</span> QgsProject.instance().mapLayers().values()
      vectorlayers <span class="op">=</span> [layer <span class="cf">for</span> layer <span class="kw">in</span> layers <span class="cf">if</span> layer.<span class="bu">type</span>() <span class="op">==</span> QgsMapLayer.VectorLayer]
      <span class="va">self</span>.dlg.comboBox.clear()
      <span class="va">self</span>.dlg.lineEdit.clear()
      <span class="va">self</span>.dlg.comboBox.addItems([layer.name() <span class="cf">for</span> layer <span class="kw">in</span> vectorlayers])
      <span class="va">self</span>.dlg.show()
      <span class="co"># Run the dialog event loop</span>
      result <span class="op">=</span> <span class="va">self</span>.dlg.exec_()
      <span class="co"># See if OK was pressed</span>
      <span class="cf">if</span> result:
        filename <span class="op">=</span> <span class="va">self</span>.dlg.lineEdit.text()
        <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> output_file:
          selectedLayerName <span class="op">=</span> <span class="va">self</span>.dlg.comboBox.currentText()
          selectedLayer <span class="op">=</span> QgsProject.instance().mapLayersByName(selectedLayerName)[<span class="dv">0</span>]
          fieldnames <span class="op">=</span> [field.name() <span class="cf">for</span> field <span class="kw">in</span> selectedLayer.fields()]
          <span class="co"># write header</span>
          line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(name <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>
          output_file.write(line)
          <span class="co"># wirte feature attributes</span>
          <span class="cf">for</span> f <span class="kw">in</span> selectedLayer.getFeatures():
            line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(<span class="bu">str</span>(f[name]) <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>
            output_file.write(line)
        <span class="va">self</span>.iface.messageBar().pushMessage(
          <span class="st">&#39;Success&#39;</span>, <span class="st">&#39;Output file written at &#39;</span> <span class="op">+</span> filename, level<span class="op">=</span>Qgis.Success)</code></pre></div>
<p>Reload and you will see the fully functioning plugin.</p>
<p><img src="images/pyqgis/dialogcomplete.png" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="writing-python-expression-functions" class="section level1">
<h1>Writing Python Expression Functions</h1>
<p>Expressions in QGIS have a lot of power and are used in many core features: selection, calculating field values, styling, labeling etc. QGIS also has support for user-defined expressions. With a little bit of python programming, you can define your own functions that can be used within the expression engine.</p>
<p>Custom python functions in QGIS use <code>@qgsfunction</code> decorator to make the function available across the system.</p>
<div id="custom-function-to-find-utm-zone-of-a-feature" class="section level2">
<h2>Custom function to find UTM Zone of a feature</h2>
<p>We will define a custom function that finds the UTM zone number of a map feature. Open the project <code>places.qgz</code> from the data directory.</p>
<p>Click the <em>Select features using an expression button</em> on the Attributes Toolbar.</p>
<p><img src="images/pyqgis/expressionselect.png" style="display: block; margin: auto;" /> In the Select by Expression dialog, switch to the Function Editor tab. Here you can write any PyQGIS code that will be executed by the expression engine. We will define a new function called <code>GetUtmZone()</code>. Note the use of <code>@qgsfunction</code> decorator which registers this function with the expression engine. Enter the following code and save the file as <code>utm_zone.py</code></p>
<p><code>utm_zone.py</code></p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> math
<span class="im">from</span> qgis.core <span class="im">import</span> <span class="op">*</span>
<span class="im">from</span> qgis.gui <span class="im">import</span> <span class="op">*</span>

<span class="at">@qgsfunction</span>(args<span class="op">=</span><span class="st">&#39;auto&#39;</span>, group<span class="op">=</span><span class="st">&#39;Custom&#39;</span>, usesgeometry<span class="op">=</span><span class="va">True</span>)
<span class="kw">def</span> GetUtmZone(feature, parent):
    <span class="co">&quot;&quot;&quot;Return the UTM Zone of the feature&#39;s geometry as a String&quot;&quot;&quot;</span>
    centroid <span class="op">=</span> feature.geometry()
    longitude <span class="op">=</span> centroid.asPoint().x()
    latitude <span class="op">=</span> centroid.asPoint().y()
    zone_number <span class="op">=</span> math.floor(((longitude <span class="op">+</span> <span class="dv">180</span>) <span class="op">/</span> <span class="dv">6</span>) <span class="op">%</span> <span class="dv">60</span>) <span class="op">+</span> <span class="dv">1</span>

    <span class="cf">if</span> latitude <span class="op">&gt;=</span> <span class="dv">0</span>:
        zone_letter <span class="op">=</span> <span class="st">&#39;N&#39;</span>
    <span class="cf">else</span>:
        zone_letter <span class="op">=</span> <span class="st">&#39;S&#39;</span>

    <span class="cf">return</span> <span class="st">&#39;</span><span class="sc">%d%s</span><span class="st">&#39;</span> <span class="op">%</span> (<span class="bu">int</span>(zone_number), zone_letter)</code></pre></div>
<p><img src="images/pyqgis/expressionwrite.png" style="display: block; margin: auto;" /></p>
<p>Switch to the <em>Expression</em> tab in the Select by expression dialog. Find and expand the <em>Custom</em> group in the Functions section. You will notice a new custom function <code>GetUtmZone</code> in the list. We can now use this function in the expressions just like any other function. Type the following expression in the editor and click <em>Select</em>.</p>
<pre><code>GetUtmZone() = &#39;44N&#39;</code></pre>
<p><img src="images/pyqgis/expressionuse.png" style="display: block; margin: auto;" /></p>
<p>Back in the main QGIS window, you should see some points highlighted in yellow. These are the points falling in the UTM Zone we specified in the expression. <img src="images/pyqgis/expressionselectedmap.png" style="display: block; margin: auto;" /></p>
<p>You can also use the expression in the field calculator. Open the field calculator and add a new virtual field called <code>utmzone</code> with the following expression</p>
<pre><code>GetUtmZone()</code></pre>
<p><img src="images/pyqgis/expressionaddfield.png" style="display: block; margin: auto;" /></p>
<p>You will see the attribute table updates with the corresponding utm zone for each feature.</p>
<p><img src="images/pyqgis/expressiontable.png" style="display: block; margin: auto;" /></p>
</div>
<div id="exercise-2" class="section level2">
<h2>Exercise</h2>
<p>Write a new custom function called <code>unique_values()</code> that takes the a comma-separated string value and removes duplicate values.</p>
<p>For example,</p>
<pre><code>&#39;cat,mouse,dog,mouse&#39; --&gt; &#39;cat,mouse,dog&#39;</code></pre>
<p>Test this function by reading values from the <code>allnames</code> column and creating a new column <code>uniquenames</code>.</p>
<p>Below is the template to get started.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">from</span> qgis.core <span class="im">import</span> <span class="op">*</span>
<span class="im">from</span> qgis.gui <span class="im">import</span> <span class="op">*</span>

<span class="at">@qgsfunction</span>(args<span class="op">=</span><span class="st">&#39;auto&#39;</span>, group<span class="op">=</span><span class="st">&#39;Custom&#39;</span>)
<span class="kw">def</span> unique_values(value, feature, parent):
    <span class="co"># Write your code here</span></code></pre></div>
</div>
</div>
<div id="resources-for-further-learning" class="section level1">
<h1>Resources for Further Learning</h1>
<ul>
<li>Official QGIS Documentation - <a href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/">PyQGIS Developer Cookbook</a></li>
<li><a href="https://anitagraser.com/pyqgis-101-introduction-to-qgis-python-programming-for-non-programmers/">PyQGIS 101: Introduction to QGIS Python programming for non-programmers</a> by Anita Graser</li>
<li><a href="https://webgeodatavore.github.io/pyqgis-samples/">PyQGIS Samples</a> by Thomas Gratier</li>
</ul>
</div>
<div id="data-credits" class="section level1">
<h1>Data Credits</h1>
<ul>
<li><code>blocks</code>, <code>parcels</code>, <code>streets</code>, <code>zoning</code>, <code>trees</code>, <code>seasmic_zones</code>. Downloaded from <a href="https://datasf.org/opendata/">DataSF Open Data Portal</a></li>
<li><code>srtm</code> NASA Shuttle Radar Topography Mission Global 1 arc second provided by The Land Processes Distributed Active Archive Center (LP DAAC). Downloaded using <a href="https://dwtkns.com/srtm30m/">30-Meter SRTM Tile Downloader</a></li>
<li><code>aoi</code>: CA Places Boundaries from 2016 TIGER/Line Shapefiles. Downloaded from <a href="https://data.ca.gov/dataset/ca-geographic-boundaries">California Open Data Portal</a></li>
<li><code>populated_places</code>: Made with Natural Earth. Free vector and raster map data @ <a href="https://www.naturalearthdata.com/">naturalearthdata.com</a></li>
</ul>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>This course is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US">Creative Commons Attribution 4.0 International License</a>. You are free to use the material in any form as you wish. Kindly give appropriate credit to the original author.</p>
<p>© 2019 Ujaval Gandhi <a href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>See <a href="https://qgis.org/api/3.4/classQgsProject.html" class="uri">https://qgis.org/api/3.4/classQgsProject.html</a><a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>Code reference: <a href="https://gist.github.com/rochacbruno/2883505" class="uri">https://gist.github.com/rochacbruno/2883505</a><a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>Code reference: <a href="https://gis.stackexchange.com/questions/266360/pyqgis-when-we-search-based-on-the-distance-between-two-points-is-the-measurem" class="uri">https://gis.stackexchange.com/questions/266360/pyqgis-when-we-search-based-on-the-distance-between-two-points-is-the-measurem</a><a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>Code reference <a href="https://gis.stackexchange.com/questions/318816/add-help-menu-entry-in-qgis-3-from-startup-py" class="uri">https://gis.stackexchange.com/questions/318816/add-help-menu-entry-in-qgis-3-from-startup-py</a><a href="#fnref4">↩</a></p></li>
<li id="fn5"><p>Code reference <a href="https://github.com/qgis/QGIS/blob/8a3c7b14c367771d096b4a6d006aa3c4b1017dd5/tests/src/python/utilities.py" class="uri">https://github.com/qgis/QGIS/blob/8a3c7b14c367771d096b4a6d006aa3c4b1017dd5/tests/src/python/utilities.py</a><a href="#fnref5">↩</a></p></li>
<li id="fn6"><p>Code reference <a href="https://anitagraser.com/pyqgis-101-introduction-to-qgis-python-programming-for-non-programmers/pyqgis101-creating-editing-a-new-vector-layer/" class="uri">https://anitagraser.com/pyqgis-101-introduction-to-qgis-python-programming-for-non-programmers/pyqgis101-creating-editing-a-new-vector-layer/</a><a href="#fnref6">↩</a></p></li>
<li id="fn7"><p>Code reference <a href="https://gis.stackexchange.com/questions/285346/add-layers-to-geopackage-using-pyqgis-qgis-3" class="uri">https://gis.stackexchange.com/questions/285346/add-layers-to-geopackage-using-pyqgis-qgis-3</a><a href="#fnref7">↩</a></p></li>
<li id="fn8"><p>Code reference <a href="https://gis.stackexchange.com/questions/292136/qgspallayersettings-error/294019" class="uri">https://gis.stackexchange.com/questions/292136/qgspallayersettings-error/294019</a><a href="#fnref8">↩</a></p></li>
<li id="fn9"><p>Code reference: <a href="https://gis.stackexchange.com/a/340615/5160" class="uri">https://gis.stackexchange.com/a/340615/5160</a><a href="#fnref9">↩</a></p></li>
</ol>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
