<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title></title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<div id="raster-computation" class="section level1">
<h1>Raster Computation</h1>
<p>In the previous section we saw how RasterIO can help us read and write geospatial rasters and use built-in modules to do some geoprocessing. In this section we will see how we can do computation on the rasters. As RasterIO reads raster bands as NumPy arrays, we can apply any operation on the data that is supported by NumPy.</p>
<p>In this example, we will take a satellite image from the Sentinel-2 satellite and see how we can create various composites and calculate NDVI (Normalized Differential Vegetation Index).</p>
<div class="figure">
<img src="images/python_foundation/ndvi.png" />

</div>
<pre class="python"><code>import os
data_pkg_path = &#39;data&#39;
sentinel2_dir = &#39;sentinel2&#39;</code></pre>
<p>The directory contains 4 JPEG2000 files with the <code>.jp2</code> extension. It also contains other metadata files. We saw how the <code>os.listdir()</code> function can help find all files in the directory, but if we wanted to find a subset of files that match a pattern, Python has another helpful module called <code>glob</code>. It allows us the to use unix-style <a href="https://tldp.org/LDP/GNU-Linux-Tools-Summary/html/x11655.htm">wildcards</a> such as <code>*</code>, <code>?</code> etc. in Python to match filenames.</p>
<p>Below code finds all files that end with <code>.jp2</code>.</p>
<pre class="python"><code>import glob

pattern = &#39;*.jp2&#39;

path = os.path.join(data_pkg_path, sentinel2_dir, pattern)
files = glob.glob(path)
print(files)</code></pre>
<pre><code>[&#39;data\\sentinel2\\T43PGQ_20200218T050851_B02.jp2&#39;, &#39;data\\sentinel2\\T43PGQ_20200218T050851_B03.jp2&#39;, &#39;data\\sentinel2\\T43PGQ_20200218T050851_B04.jp2&#39;, &#39;data\\sentinel2\\T43PGQ_20200218T050851_B08.jp2&#39;]</code></pre>
<p>Each file is a separate band from the same scene. The band names are part of the file name, so we can use the <code>in</code> operator to check which the file corresponding to each band name.</p>
<pre class="python"><code>bands = {
    &#39;red&#39;: &#39;B04&#39;,
    &#39;green&#39;: &#39;B03&#39;,
    &#39;blue&#39;: &#39;B02&#39;,
    &#39;nir&#39;: &#39;B08&#39;
}
band_files = {}

for band_name, band_number in bands.items():
    for filename in files:
        if band_number in filename:
            band_files[band_name] = filename
print(band_files)</code></pre>
<pre><code>{&#39;red&#39;: &#39;data\\sentinel2\\T43PGQ_20200218T050851_B04.jp2&#39;, &#39;green&#39;: &#39;data\\sentinel2\\T43PGQ_20200218T050851_B03.jp2&#39;, &#39;blue&#39;: &#39;data\\sentinel2\\T43PGQ_20200218T050851_B02.jp2&#39;, &#39;nir&#39;: &#39;data\\sentinel2\\T43PGQ_20200218T050851_B08.jp2&#39;}</code></pre>
<p>All the files come from the same scene and have the same metadata. Let’s open any one of the file and read the metadata.</p>
<pre class="python"><code>import rasterio

red_dataset = rasterio.open(band_files[&#39;red&#39;])
metadata = red_dataset.meta
print(metadata)</code></pre>
<pre><code>{&#39;driver&#39;: &#39;JP2OpenJPEG&#39;, &#39;dtype&#39;: &#39;uint16&#39;, &#39;nodata&#39;: None, &#39;width&#39;: 10980, &#39;height&#39;: 10980, &#39;count&#39;: 1, &#39;crs&#39;: CRS.from_epsg(32643), &#39;transform&#39;: Affine(10.0, 0.0, 699960.0,
       0.0, -10.0, 1500000.0)}</code></pre>
<p>We can now loop through all bands and read the data.</p>
<pre class="python"><code>band_datasets = {}
for band_name, band_file in band_files.items():
    dataset = rasterio.open(band_file)
    band_dataset = dataset.read(1)
    band_datasets[band_name] = band_dataset
    dataset.close()
print(band_datasets)</code></pre>
<pre><code>{&#39;red&#39;: array([[   0,    0,    0, ..., 1683, 1678, 1624],
       [   0,    0,    0, ..., 1571, 1737, 1636],
       [   0,    0,    0, ..., 1307, 1537, 1332],
       ...,
       [1167, 1161, 1055, ..., 1499, 1457, 1453],
       [1235, 1183, 1085, ..., 1479, 1484, 1479],
       [1275, 1261, 1168, ..., 1541, 1539, 1473]], dtype=uint16), &#39;green&#39;: array([[   0,    0,    0, ..., 1189, 1161, 1144],
       [   0,    0,    0, ..., 1169, 1196, 1129],
       [   0,    0,    0, ..., 1087, 1169, 1097],
       ...,
       [1077, 1075,  972, ..., 1198, 1193, 1210],
       [1087, 1089,  985, ..., 1209, 1211, 1213],
       [1134, 1105, 1031, ..., 1238, 1232, 1221]], dtype=uint16), &#39;blue&#39;: array([[   0,    0,    0, ..., 1132, 1121, 1088],
       [   0,    0,    0, ..., 1121, 1146, 1108],
       [   0,    0,    0, ..., 1100, 1158, 1066],
       ...,
       [1167, 1164, 1094, ..., 1187, 1184, 1175],
       [1174, 1163, 1132, ..., 1190, 1204, 1198],
       [1205, 1173, 1170, ..., 1229, 1215, 1191]], dtype=uint16), &#39;nir&#39;: array([[   0,    0,    0, ..., 2348, 2342, 2279],
       [   0,    0,    0, ..., 2571, 2482, 2273],
       [   0,    0,    0, ..., 2436, 2390, 2289],
       ...,
       [2148, 2047, 2001, ..., 2451, 2474, 2587],
       [2211, 2097, 2006, ..., 2441, 2445, 2533],
       [2219, 2100, 1995, ..., 2457, 2449, 2566]], dtype=uint16)}</code></pre>
<div id="combining-bands-into-a-composite" class="section level2">
<h2>Combining Bands into a Composite</h2>
<p>Let’s see how we can combine the individual bands into a single raster with 3 bands. This was we can create a true-color or false-color composite.</p>
<p>We can combine the ‘red’, ‘green’ and ‘blue’ bands to form a RGB (true-color) composite image.</p>
<p>We can use the same metadata parameters as the input image, with one little change. We can update the band count to 3. Since <code>metadata</code> is a dictionary, we can use the <code>update()</code> method to change set a key to a new value.</p>
<pre class="python"><code>metadata.update({&#39;count&#39;:3})</code></pre>
<p>We have a dictionary that contains all the metadata parameters that we can pass to the <code>rasterio.open()</code> method. But a function accepts arguments in the form of keywords, such as <code>count=3, dtype=uint16, ....</code>. Python provides a special operator <code>**</code> which converts a dictionary into keyword arguments suitable to be passed to functions.</p>
<pre class="python"><code>output_filename = &#39;rgb.jp2&#39;
output_dir = &#39;output&#39;
output_path = os.path.join(output_dir, output_filename)

rgb_dataset = rasterio.open(output_path, &#39;w&#39;, **metadata)</code></pre>
<p>Now the dataset is created, we can write data from each band.</p>
<pre class="python"><code>rgb_dataset.write(band_datasets[&#39;red&#39;], 1)
rgb_dataset.write(band_datasets[&#39;green&#39;], 2)
rgb_dataset.write(band_datasets[&#39;blue&#39;], 3)
rgb_dataset.close()</code></pre>
</div>
<div id="calculating-ndvi" class="section level2">
<h2>Calculating NDVI</h2>
<p>We can perform band-math on the datasets using NumPy functions. We will use the Red and NIR bands on the input image to calculate NDVI.</p>
<p>The forumla for computing NDVI is as follows</p>
<p><code>NDVI = (NIR - RED) / ( NIR + RED)</code></p>
<p>Before we do so, we need to set the correct data type for the input data. The input bands contains integer values and are stored as the <code>uint16</code> (unsigned integer 16-bits). When we do some operation on 2 numbers that are unsigned (meaning they can’t store negative values), but output is a negative number, it results an <a href="https://en.wikipedia.org/wiki/Integer_overflow">integer overflow</a> error. See below example.</p>
<pre class="python"><code>import numpy as np
a = np.array([10], dtype=np.uint16)
b = np.array([20], dtype=np.uint16)

print(a-b)</code></pre>
<pre><code>[65526]</code></pre>
<p>If we expect the results maybe negative, we can change the datatype to one that supports negative numbers.</p>
<pre class="python"><code>a = a.astype(np.int16)
b = b.astype(np.int16)
print(a-b)</code></pre>
<pre><code>[-10]</code></pre>
<p>Since NDVI values can be negative and also any real number, we should change the type to a floating point type.</p>
<pre class="python"><code>red = band_datasets[&#39;red&#39;].astype(np.float32)
nir = band_datasets[&#39;nir&#39;].astype(np.float32)</code></pre>
<p>Before we do the calculation, we need to deal with one more potential issue. Since the NDVI formula requires us to divide numbers, we may end up accidentely dividing a number with 0. Let’s see what happens if we divide a number by 0.</p>
<pre class="python"><code>print(a/0)</code></pre>
<pre><code>[inf]


C:\Users\ujaval\anaconda3\envs\python_foundation\lib\site-packages\ipykernel_launcher.py:1: RuntimeWarning: divide by zero encountered in true_divide
  &quot;&quot;&quot;Entry point for launching an IPython kernel.</code></pre>
<p>To avoice this warning of division by zero, we can set NumPy to ignore such cases</p>
<pre class="python"><code>np.seterr(divide=&#39;ignore&#39;, invalid=&#39;ignore&#39;)</code></pre>
<pre><code>{&#39;divide&#39;: &#39;warn&#39;, &#39;over&#39;: &#39;warn&#39;, &#39;under&#39;: &#39;ignore&#39;, &#39;invalid&#39;: &#39;warn&#39;}</code></pre>
<p>Now we can do the calculations using regular Python syntax.</p>
<pre class="python"><code>ndvi = (nir - red) / (nir + red)</code></pre>
<p>We can now write the resulting rastre to disk. Since the JP2 driver supports writing only integer data, we can choose to write it as a GeoTIFF file.</p>
<pre class="python"><code>metadata.update({&#39;count&#39;: 1, &#39;dtype&#39;: &#39;float32&#39;, &#39;driver&#39;: &#39;GTiff&#39;})
print(metadata)</code></pre>
<pre><code>{&#39;driver&#39;: &#39;GTiff&#39;, &#39;dtype&#39;: &#39;float32&#39;, &#39;nodata&#39;: None, &#39;width&#39;: 10980, &#39;height&#39;: 10980, &#39;count&#39;: 1, &#39;crs&#39;: CRS.from_epsg(32643), &#39;transform&#39;: Affine(10.0, 0.0, 699960.0,
       0.0, -10.0, 1500000.0)}</code></pre>
<pre class="python"><code>output_filename = &#39;ndvi.tif&#39;
output_dir = &#39;output&#39;
output_path = os.path.join(output_dir, output_filename)

ndvi_dataset = rasterio.open(output_path, &#39;w&#39;, **metadata)
ndvi_dataset.write(ndvi, 1)
ndvi_dataset.close()</code></pre>
</div>
<div id="exercise" class="section level2">
<h2>Exercise</h2>
<p>Take the Sentinel-2 bands and create a False Color Composite (FCC). A <em>NRG Color Composite</em> is created with the following configuration.</p>
<ul>
<li>Band 1: NIR</li>
<li>Band 2: Red</li>
<li>Band 3: Green</li>
</ul>
<hr />
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
